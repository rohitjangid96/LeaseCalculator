<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Lease Processing - Results Summary</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        /* Bulk results page-specific overrides */
        body {
            background: var(--color-bg-light);
        }
        .header {
            background: var(--color-brand-green);
        }
        .header h1 {
            font-size: 1.5rem !important;
        }
        .controls {
            background: var(--color-sage-1);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }
        .stat-card {
            background: white;
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--color-brand-green);
            transition: var(--transition-base);
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .stat-card h3 {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-sm);
        }
        .stat-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--color-text-primary);
        }
        .stat-card .label {
            font-size: 0.85rem;
            color: var(--color-text-muted);
            margin-top: var(--spacing-xs);
        }
        thead,
        table thead th,
        .results-table thead,
        .results-table thead tr {
            background: var(--color-sage-1) !important;
            color: var(--color-text-primary) !important;
        }
        .totals-section {
            background: var(--color-sage-1);
        }
        .total-value {
            color: var(--color-brand-green);
        }
        .gaap-tabs {
            border-bottom: 2px solid var(--color-border-sage);
        }
        .gaap-tab {
            background: var(--color-sage-1);
        }
        .gaap-tab.active {
            color: var(--color-brand-green);
            border-bottom-color: var(--color-brand-green);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>📊 Bulk Lease Processing</h1>
        <div class="user-info">
            <span>Welcome, <strong id="username">User</strong></span>
            <button class="btn btn-primary" onclick="window.location.href='dashboard.html'">Home</button>
            <button class="btn btn-primary" onclick="window.location.href='calculate.html'">Calculate</button>
            <button class="btn btn-primary" onclick="window.location.href='bulk_results.html'">Bulk Results</button>
            <button class="btn" onclick="logout()">Logout</button>
        </div>
    </div>
    <div class="container">
        <p class="subtitle">Process multiple leases and view consolidated results</p>

        <div class="controls">
            <div class="control-group">
                <div class="control-item">
                    <label>From Date</label>
                    <input type="date" id="fromDate" required>
                </div>
                <div class="control-item">
                    <label>To Date</label>
                    <input type="date" id="toDate" required>
                </div>
                <div class="control-item">
                    <label>GAAP Standard</label>
                    <select id="gaapStandard">
                        <option value="IFRS">IFRS</option>
                        <option value="IndAS">IndAS</option>
                        <option value="US-GAAP">US-GAAP</option>
                    </select>
                </div>
            </div>
            
            <div class="control-group" style="margin-top: 10px;">
                <div class="control-item">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="includeGaapComparison" style="width: auto; margin: 0;">
                        Compare All GAAP Standards
                    </label>
                </div>
            </div>

            <div class="control-group">
                <div class="control-item">
                    <label>Filter by Cost Center</label>
                    <select id="costCenterFilter">
                        <option value="">All Cost Centers</option>
                    </select>
                </div>
                <div class="control-item">
                    <label>Filter by Entity</label>
                    <select id="entityFilter">
                        <option value="">All Entities</option>
                    </select>
                </div>
                <div class="control-item">
                    <label>Filter by Asset Class</label>
                    <select id="assetClassFilter">
                        <option value="">All Asset Classes</option>
                    </select>
                </div>
            </div>

            <div style="margin-top: 15px;">
                <button class="btn btn-primary" onclick="processBulkLeases()">
                    🔄 Process All Leases
                </button>
                <button class="btn btn-primary" onclick="exportToExcel()" style="margin-left: 10px;" id="exportBtn" disabled>
                    📥 Export to Excel
                </button>
                <button class="btn btn-primary" onclick="showEmailModal()" style="margin-left: 10px;" id="emailBtn" disabled>
                    📧 Email Report
                </button>
            </div>
        </div>

        <div id="messageArea"></div>

        <div id="statsArea" style="display: none;">
            <div class="stats" id="statsCards"></div>
        </div>

        <div id="resultsArea" style="display: none;">
            <h2 style="margin-bottom: 20px;">Results Summary Table</h2>
            
            <!-- GAAP Comparison Tabs (shown when comparison enabled) -->
            <div id="gaapTabs" class="gaap-tabs" style="display: none;">
                <button class="gaap-tab active" onclick="switchGaapTab('IFRS')">IFRS</button>
                <button class="gaap-tab" onclick="switchGaapTab('IndAS')">IndAS</button>
                <button class="gaap-tab" onclick="switchGaapTab('US-GAAP')">US-GAAP</button>
            </div>
            
            <div class="results-table">
                <table id="resultsTable">
                    <thead id="resultsTableHead"></thead>
                    <tbody id="resultsTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="totalsArea" style="display: none;">
            <div class="totals-section">
                <h3>Aggregated Totals</h3>
                <div class="totals-grid" id="totalsGrid"></div>
            </div>
        </div>
    </div>

    <!-- XLSX Library for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        let currentResults = null;
        let allLeases = [];
        let gaapComparisonData = null;
        let currentGaapView = 'IFRS';

        async function loadLeasesForBulk() {
            try {
                const response = await fetch('http://localhost:5001/api/leases', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    allLeases = data.leases || [];
                    populateFilters(allLeases);
                }
            } catch (error) {
                console.error('Failed to load leases:', error);
                showMessage('Failed to load leases', 'error');
            }
        }

        function populateFilters(leases) {
            const costCenters = new Set();
            const entities = new Set();
            const assetClasses = new Set();

            leases.forEach(lease => {
                if (lease.cost_centre) costCenters.add(lease.cost_centre);
                if (lease.group_entity_name) entities.add(lease.group_entity_name);
                if (lease.asset_class && lease.asset_class !== 'N/A') assetClasses.add(lease.asset_class);
            });

            populateSelect('costCenterFilter', Array.from(costCenters).sort());
            populateSelect('entityFilter', Array.from(entities).sort());
            populateSelect('assetClassFilter', Array.from(assetClasses).sort());
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            options.forEach(option => {
                const optionEl = document.createElement('option');
                optionEl.value = option;
                optionEl.textContent = option;
                select.appendChild(optionEl);
            });
        }

        async function processBulkLeases() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;

            if (!fromDate || !toDate) {
                showMessage('Please select both From Date and To Date', 'error');
                return;
            }

            showMessage('Processing leases...', 'loading');

            try {
                const includeComparison = document.getElementById('includeGaapComparison').checked;
                const payload = {
                    from_date: fromDate,
                    to_date: toDate,
                    gaap_standard: document.getElementById('gaapStandard').value,
                    cost_center: document.getElementById('costCenterFilter').value || null,
                    entity: document.getElementById('entityFilter').value || null,
                    asset_class: document.getElementById('assetClassFilter').value || null,
                    include_disclosures: true,  // Request disclosures generation
                    include_gaap_comparison: includeComparison  // Request GAAP comparison
                };

                const response = await fetch('http://localhost:5001/api/calculate_leases', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    currentResults = data;
                    gaapComparisonData = data.gaap_comparison || null;
                    displayResults(data);
                    showMessage(`Successfully processed ${data.stats.processed_count} leases`, 'success');
                } else {
                    showMessage(data.error || 'Failed to process leases', 'error');
                }
            } catch (error) {
                console.error('Error processing leases:', error);
                showMessage('Error processing leases: ' + error.message, 'error');
            }
        }

        function displayResults(data) {
            // Display stats
            displayStats(data.stats);
            
            // Show/hide GAAP comparison tabs
            const gaapTabs = document.getElementById('gaapTabs');
            if (gaapComparisonData) {
                gaapTabs.style.display = 'flex';
                // Display the selected GAAP view
                switchGaapTab(currentGaapView);
            } else {
                gaapTabs.style.display = 'none';
                // Display results table
                displayResultsTable(data.results);
                // Display aggregated totals
                displayAggregatedTotals(data.aggregated_totals);
            }
            
            document.getElementById('exportBtn').disabled = false;
            document.getElementById('emailBtn').disabled = false;
        }
        
        function switchGaapTab(gaapStandard) {
            currentGaapView = gaapStandard;
            
            // Update active tab
            document.querySelectorAll('.gaap-tab').forEach(tab => {
                if (tab.textContent === gaapStandard) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Display results for the selected GAAP standard
            if (gaapComparisonData && gaapComparisonData[gaapStandard]) {
                const gaapData = gaapComparisonData[gaapStandard];
                displayResultsTable(gaapData.results);
                displayAggregatedTotals(gaapData.aggregated_totals);
            }
        }

        function displayStats(stats) {
            const statsArea = document.getElementById('statsArea');
            const statsCards = document.getElementById('statsCards');
            statsArea.style.display = 'block';
            
            statsCards.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Processed</div>
                    <div class="stat-value">${stats.processed_count || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Skipped</div>
                    <div class="stat-value">${stats.skipped_count || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Leases</div>
                    <div class="stat-value">${stats.total_count || 0}</div>
                </div>
            `;
        }

        function displayResultsTable(results) {
            if (!results || results.length === 0) {
                document.getElementById('resultsArea').style.display = 'none';
                return;
            }

            document.getElementById('resultsArea').style.display = 'block';
            
            // Get all unique keys from results to build columns
            // Include all new columns: Z4, AA4, AB4, AC4-AG4, BB4, BC4, BD4, BE4, BI4
            const columns = [
                // Identifiers
                'lease_id', 'description', 'asset_class', 'asset_id_code',
                // Closing Balances
                'opening_liability', 'closing_liability_total', 'closing_liability_current', 'closing_liability_non_current',
                'opening_rou_asset', 'closing_rou_asset',
                // Period Activity
                'interest_expense', 'depreciation_expense', 'rent_paid',
                'closing_security_deposit', 'closing_aro_liability',
                'gain_loss_pnl', 
                // New Columns (Z4, AA4, AB4, BB4, BC4, BD4, BE4, BI4)
                'original_lease_id', 'modification_indicator', 'initial_rou_asset',
                'security_deposit_gross', 'accumulated_depreciation',
                'initial_direct_expenditure_period', 'prepaid_accrual_period',
                'covid_pe_gain', 'remaining_rou_life',
                // Projection Columns (AC4-AG4) - Show first 3 periods
                'projection_1_liability_ad', 'projection_1_rou_ac', 'projection_1_depreciation_ae',
                'projection_2_liability_ad', 'projection_2_rou_ac',
                // Gain/Loss Breakdown
                'modification_gain', 'sublease_gain_loss', 'sublease_modification_gain_loss', 'termination_gain_loss',
                // Security Deposit Split (M4, N4)
                'closing_security_deposit_current', 'closing_security_deposit_non_current',
                // Other fields
                'currency', 'cost_centre', 'borrowing_rate'
            ];

            // Fields that should NOT be formatted as currency (IDs, text fields)
            const nonCurrencyFields = [
                'lease_id', 'description', 'asset_class', 'asset_id_code', 'currency', 'cost_centre',
                'original_lease_id', 'modification_indicator', 'remaining_rou_life'
            ];

            // Build table header
            const thead = document.getElementById('resultsTableHead');
            thead.innerHTML = '<tr>' + columns.map(col => `<th>${col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</th>`).join('') + '</tr>';

            // Build table body
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = results.map(row => {
                return '<tr>' + columns.map(col => {
                    const value = row[col];
                    if (typeof value === 'number' && !nonCurrencyFields.includes(col)) {
                        return `<td style="text-align: right;">${formatCurrency(value)}</td>`;
                    } else if (typeof value === 'number' && nonCurrencyFields.includes(col)) {
                        // For numeric IDs, just display as integer
                        return `<td style="text-align: right;">${Math.round(value)}</td>`;
                    }
                    return `<td>${value || ''}</td>`;
                }).join('') + '</tr>';
            }).join('');
        }

        function displayAggregatedTotals(totals) {
            if (!totals) return;

            document.getElementById('totalsArea').style.display = 'block';
            const grid = document.getElementById('totalsGrid');
            
            // Fields that should NOT be formatted as currency
            const nonCurrencyFields = ['total_leases'];
            
            grid.innerHTML = Object.entries(totals).map(([key, value]) => {
                const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                const displayValue = typeof value === 'number' && !nonCurrencyFields.includes(key) 
                    ? formatCurrency(value) 
                    : (typeof value === 'number' ? value : value);
                return `
                    <div class="total-item">
                        <span class="total-label">${label}:</span>
                        <span class="total-value">${displayValue}</span>
                    </div>
                `;
            }).join('');
        }

        function formatCurrency(value) {
            if (value === null || value === undefined) return '$0.00';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'loading';
            messageArea.innerHTML = `<div class="${className}">${message}</div>`;
        }

        function exportToExcel() {
            if (!currentResults) {
                showMessage('No results to export', 'error');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // 1. ENHANCED Summary Sheet with metadata
            const today = new Date();
            const summaryData = [
                ['LEASE PORTFOLIO SUMMARY REPORT'],
                [],
                ['Report Information'],
                ['Generated Date', today.toLocaleDateString() + ' ' + today.toLocaleTimeString()],
                ['Reporting Period', `${currentResults.filters?.from_date || 'N/A'} to ${currentResults.filters?.to_date || 'N/A'}`],
                ['GAAP Standard', currentResults.filters?.gaap_standard || 'IFRS'],
                [],
                ['Aggregated Financial Totals'],
                ...Object.entries(currentResults.aggregated_totals || {}).map(([key, value]) => [
                    key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    typeof value === 'number' ? value : value
                ]),
                [],
                ['Processing Statistics'],
                ['Total Leases Processed', currentResults.processed_count || 0],
                ['Total Leases Skipped', currentResults.skipped_count || 0],
                ['Total Leases', currentResults.total_count || 0],
            ];
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            summaryWs['!cols'] = [{ wch: 35 }, { wch: 25 }];
            // Format currency values
            const summaryRange = XLSX.utils.decode_range(summaryWs['!ref']);
            for (let R = 9; R < summaryRange.e.r - 4; R++) {  // Format financial totals, not stats
                const cell = summaryWs['B' + (R + 1)];
                if (cell && cell.t === 'n') cell.z = '$#,##0.00';
            }
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
            
            // 2. Results Sheet (Bulk Lease Results - all new columns)
            if (currentResults.results && currentResults.results.length > 0) {
                // Get all columns from first result
                const allColumns = Object.keys(currentResults.results[0]);
                
                // Create header row
                const resultsData = [allColumns.map(col => col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()))];
                
                // Add data rows
                currentResults.results.forEach(row => {
                    resultsData.push(allColumns.map(col => {
                        const value = row[col];
                        // Handle dates
                        if (typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}/)) {
                            return new Date(value);
                        }
                        return value !== null && value !== undefined ? value : '';
                    }));
                });
                
                const resultsWs = XLSX.utils.aoa_to_sheet(resultsData);
                
                // Set column widths
                const colWidths = allColumns.map(() => ({ wch: 15 }));
                resultsWs['!cols'] = colWidths;
                
                // Format currency columns (columns with numeric values, not IDs or text)
                const nonCurrencyFields = ['lease_id', 'description', 'asset_class', 'asset_id_code', 'currency', 'cost_centre',
                                         'original_lease_id', 'modification_indicator'];
                const range = XLSX.utils.decode_range(resultsWs['!ref']);
                for (let R = 1; R <= range.e.r; R++) {
                    allColumns.forEach((col, colIdx) => {
                        if (!nonCurrencyFields.includes(col)) {
                            const cellRef = XLSX.utils.encode_cell({ r: R, c: colIdx });
                            if (resultsWs[cellRef] && resultsWs[cellRef].t === 'n') {
                                resultsWs[cellRef].z = '$#,##0.00';
                            }
                        }
                    });
                }
                
                XLSX.utils.book_append_sheet(wb, resultsWs, 'Results');
            }
            
            // 3. Consolidated Journal Entries Sheet
            if (currentResults.consolidated_journals && currentResults.consolidated_journals.length > 0) {
                const journalHeaders = ['Account Code', 'Account Name', 'BS/PL', 'Opening Balance', 
                                       'Previous Period', 'Result Period', 'Incremental Adjustment',
                                       'IFRS Adjustment', 'US-GAAP Entry'];
                const journalData = [journalHeaders];
                
                currentResults.consolidated_journals.forEach(entry => {
                    journalData.push([
                        entry.account_code || '',
                        entry.account_name || '',
                        entry.bs_pl || '',
                        entry.opening_balance || 0,
                        entry.previous_period || 0,
                        entry.result_period || 0,
                        entry.incremental_adjustment || 0,
                        entry.ifrs_adjustment || 0,
                        entry.usgaap_entry || 0,
                    ]);
                });
                
                const journalWs = XLSX.utils.aoa_to_sheet(journalData);
                journalWs['!cols'] = [{ wch: 12 }, { wch: 35 }, { wch: 8 }, { wch: 18 }, { wch: 18 }, 
                                     { wch: 18 }, { wch: 22 }, { wch: 18 }, { wch: 18 }];
                
                // Format currency columns
                const range = XLSX.utils.decode_range(journalWs['!ref']);
                for (let R = 1; R <= range.e.r; R++) {
                    ['D', 'E', 'F', 'G', 'H', 'I'].forEach(col => {
                        const cellRef = journalWs[XLSX.utils.encode_cell({ r: R, c: col.charCodeAt(0) - 65 })];
                        if (cellRef && cellRef.t === 'n') {
                            cellRef.z = '$#,##0.00';
                        }
                    });
                }
                
                XLSX.utils.book_append_sheet(wb, journalWs, 'Journal Entries');
            }
            
            // 4. Disclosures Sheet (if available)
            const disclosuresData = [['Lease Accounting Disclosures']];
            const balanceSheetDate = currentResults.filters?.to_date || currentResults.to_date || new Date().toLocaleDateString();
            disclosuresData.push(['Balance Sheet Date', balanceSheetDate]);
            disclosuresData.push([]);
            
            if (currentResults.disclosures) {
                // Maturity Analysis
                disclosuresData.push(['Maturity Analysis', '', '']);
                disclosuresData.push(['Period', 'Year', 'Total Payments']);
                if (currentResults.disclosures.maturity_analysis) {
                    currentResults.disclosures.maturity_analysis.forEach(item => {
                        disclosuresData.push([
                            item.period || '',
                            item.year || item.years || '',
                            item.total_payments || 0
                        ]);
                    });
                }
                disclosuresData.push([]);
                
                // Total Lease Liability by Entity
                disclosuresData.push(['Total Lease Liability by Entity', '', '']);
                disclosuresData.push(['Entity', 'Total Liability', '']);
                if (currentResults.disclosures.liability_by_entity) {
                    Object.entries(currentResults.disclosures.liability_by_entity).forEach(([entity, amount]) => {
                        disclosuresData.push([entity, amount, '']);
                    });
                }
                disclosuresData.push([]);
                
                // Total ROU Asset by Category
                disclosuresData.push(['Total ROU Asset by Category', '', '']);
                disclosuresData.push(['Asset Class', 'Total ROU Asset', '']);
                if (currentResults.disclosures.rou_by_category) {
                    Object.entries(currentResults.disclosures.rou_by_category).forEach(([category, amount]) => {
                        disclosuresData.push([category, amount, '']);
                    });
                }
                disclosuresData.push([]);
                
                // Other disclosures
                if (currentResults.disclosures.variable_payments) {
                    disclosuresData.push(['Variable Lease Payments', '', '']);
                    disclosuresData.push(['Total Variable Payments', currentResults.disclosures.variable_payments.total_variable_payments || 0, '']);
                }
            } else {
                // Placeholder if disclosures not available
                disclosuresData.push(['Maturity Analysis', '', '']);
                disclosuresData.push(['Period', 'Year', 'Total Payments']);
                disclosuresData.push(['Note: Disclosures not calculated. Enable in API request.', '', '']);
            }
            
            const disclosuresWs = XLSX.utils.aoa_to_sheet(disclosuresData);
            disclosuresWs['!cols'] = [{ wch: 30 }, { wch: 15 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, disclosuresWs, 'Disclosures');
            
            // Download with enhanced filename
            const timestamp = today.toISOString().split('T')[0].replace(/-/g, '');
            const gaapStd = currentResults.filters?.gaap_standard || 'IFRS';
            const fileName = `Lease_Portfolio_${gaapStd}_${timestamp}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showMessage(`✅ Enhanced Excel report downloaded successfully!\n\nFile: ${fileName}\n\nContains:\n• Professional summary with metadata\n• Formatted results table\n• Consolidated journal entries\n• Regulatory disclosures\n• Proper currency formatting`, 'success');
        }

        // Load username on page load
        async function loadUsername() {
            try {
                const response = await fetch('http://localhost:5001/api/user', {
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.user) {
                        document.getElementById('username').textContent = data.user.username || 'User';
                    }
                }
            } catch (error) {
                console.error('Failed to load username:', error);
            }
        }
        
        // Load username and leases on page load
        loadUsername();
        loadLeasesForBulk();

        // Set default dates (current year)
        const today = new Date();
        const yearStart = new Date(today.getFullYear(), 0, 1);
        const yearEnd = new Date(today.getFullYear(), 11, 31);
        
        document.getElementById('fromDate').value = yearStart.toISOString().split('T')[0];
        document.getElementById('toDate').value = yearEnd.toISOString().split('T')[0];

        function logout() {
            fetch('http://localhost:5001/api/logout', {
                method: 'POST',
                credentials: 'include'
            }).then(() => {
                window.location.href = 'login.html';
            });
        }
        
        // Email Modal Functions
        function showEmailModal() {
            // Get current user's email (NOT the configured FROM email)
            fetch('http://localhost:5001/api/user', {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                const defaultEmail = (data.success && data.user && data.user.email) ? data.user.email : '';
                document.getElementById('recipientEmail').value = defaultEmail;
                document.getElementById('emailModal').style.display = 'block';
            })
            .catch(err => {
                document.getElementById('recipientEmail').value = '';
                document.getElementById('emailModal').style.display = 'block';
            });
        }
        
        function hideEmailModal() {
            document.getElementById('emailModal').style.display = 'none';
        }
        
        async function sendReportEmail() {
            const toEmail = document.getElementById('recipientEmail').value.trim();
            if (!toEmail || !toEmail.match(/^\S+@\S+\.\S+$/)) {
                showMessage('Please enter a valid recipient email', 'error');
                return;
            }
            hideEmailModal();
            
            if (!currentResults) {
                showMessage('No results to email', 'error');
                return;
            }
            
            try {
                // Generate Excel file using same logic as exportToExcel
                const today = new Date();
                const wb = XLSX.utils.book_new();
                
                // 1. Summary Sheet
                const summaryData = [
                    ['LEASE PORTFOLIO SUMMARY REPORT'],
                    [],
                    ['Report Information'],
                    ['Generated Date', today.toLocaleDateString() + ' ' + today.toLocaleTimeString()],
                    ['Reporting Period', `${currentResults.filters?.from_date || 'N/A'} to ${currentResults.filters?.to_date || 'N/A'}`],
                    ['GAAP Standard', currentResults.filters?.gaap_standard || 'IFRS'],
                    [],
                    ['Aggregated Financial Totals'],
                    ...Object.entries(currentResults.aggregated_totals || {}).map(([key, value]) => [
                        key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                        typeof value === 'number' ? value : value
                    ]),
                    [],
                    ['Processing Statistics'],
                    ['Total Leases Processed', currentResults.processed_count || 0],
                    ['Total Leases Skipped', currentResults.skipped_count || 0],
                    ['Total Leases', currentResults.total_count || 0],
                ];
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                summaryWs['!cols'] = [{ wch: 35 }, { wch: 25 }];
                XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
                
                // 2. Results Sheet
                if (currentResults.results && currentResults.results.length > 0) {
                    const allColumns = Object.keys(currentResults.results[0]);
                    const resultsData = [allColumns.map(col => col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()))];
                    currentResults.results.forEach(row => {
                        resultsData.push(allColumns.map(col => {
                            const value = row[col];
                            if (typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}/)) {
                                return new Date(value);
                            }
                            return value !== null && value !== undefined ? value : '';
                        }));
                    });
                    const resultsWs = XLSX.utils.aoa_to_sheet(resultsData);
                    XLSX.utils.book_append_sheet(wb, resultsWs, 'Results');
                }
                
                // 3. Journal Entries Sheet
                if (currentResults.consolidated_journals && currentResults.consolidated_journals.length > 0) {
                    const journalHeaders = ['Account Code', 'Account Name', 'BS/PL', 'Opening Balance', 
                                           'Previous Period', 'Result Period', 'Incremental Adjustment',
                                           'IFRS Adjustment', 'US-GAAP Entry'];
                    const journalData = [journalHeaders];
                    currentResults.consolidated_journals.forEach(entry => {
                        journalData.push([
                            entry.account_code || '',
                            entry.account_name || '',
                            entry.bs_pl || '',
                            entry.opening_balance || 0,
                            entry.previous_period || 0,
                            entry.result_period || 0,
                            entry.incremental_adjustment || 0,
                            entry.ifrs_adjustment || 0,
                            entry.usgaap_entry || 0,
                        ]);
                    });
                    const journalWs = XLSX.utils.aoa_to_sheet(journalData);
                    XLSX.utils.book_append_sheet(wb, journalWs, 'Journal Entries');
                }
                
                // Convert to blob
                const wbout = XLSX.write(wb, {bookType: 'xlsx', type: 'array'});
                const fileBlob = new Blob([wbout], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
                
                // Send via API
                const formData = new FormData();
                formData.append('to_email', toEmail);
                formData.append('attachment', fileBlob, `Lease_Portfolio_${currentResults.filters?.gaap_standard || 'IFRS'}_${today.toISOString().split('T')[0].replace(/-/g, '')}.xlsx`);
                formData.append('report_json', JSON.stringify({
                    period: `${currentResults.filters?.from_date || 'N/A'} to ${currentResults.filters?.to_date || 'N/A'}`,
                    gaap_standard: currentResults.filters?.gaap_standard || 'IFRS',
                    timestamp: today.toISOString()
                }));
                
                const response = await fetch('/api/email/send-report', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`✅ Report sent to ${toEmail}!`, 'success');
                } else {
                    showMessage('❌ Failed to send: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showMessage('❌ Error sending email: ' + error.message, 'error');
            }
        }
    </script>
    
    <!-- Email Modal -->
    <div id="emailModal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(68,66,90,0.3);">
      <div style="background: white; width: 350px; margin: 120px auto 0 auto; border-radius: 15px; box-shadow: 0 4px 30px rgba(0,0,0,0.19); padding: 24px 28px 22px 28px; position: relative;">
        <div style="font-size: 1.15rem; font-weight: bold; color: #444; margin-bottom: 12px;">📧 Email Bulk Report</div>
        <label style="font-size: 0.95rem; margin-bottom: 6px; color: #555;">Recipient Email</label>
        <input type="email" id="recipientEmail" required style="width: 100%; padding: 10px; border: 1.5px solid #ddd; border-radius: 6px; font-size: 0.97rem; margin-bottom: 16px; color: #222;">
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
          <button onclick="sendReportEmail()" style="background: #22c55e; color: white; border: none; border-radius: 6px; padding: 10px 18px; font-weight: bold;">Send</button>
          <button onclick="hideEmailModal()" style="background: #ef4444; color: white; border: none; border-radius: 6px; padding: 10px 16px;">Cancel</button>
        </div>
      </div>
    </div>
</body>
</html>


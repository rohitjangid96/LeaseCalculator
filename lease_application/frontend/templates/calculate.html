<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculate Lease</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 1.5rem; }
        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 20px;
        }
        .form-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        select, input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .results {
            display: none;
            margin-top: 30px;
        }
        .summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .summary h2 {
            margin-bottom: 15px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .summary-grid h3 {
            margin: 0 0 10px 0;
            font-size: 1rem;
            opacity: 0.95;
        }
        .summary-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
        }
        .summary-item strong {
            display: block;
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        .summary-item span {
            font-size: 1.2rem;
            font-weight: 700;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        @media (max-width: 1200px) {
            table { font-size: 0.8rem; }
            table th, table td { padding: 8px 6px; }
        }
        thead {
            background: #667eea;
            color: white;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            font-weight: 600;
        }
        /* Table styles - reverted to original scrollable behavior */
        #scheduleTable {
            border-collapse: collapse;
        }
        tbody tr:hover {
            background: #f8f9fa;
        }
        .scrollable {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: auto;
            position: relative;
        }
        .scrollable table {
            min-width: 1400px; /* Ensure all 15 columns fit */
        }
        .error {
            color: #e74c3c;
            background: #ffe5e5;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Calculate Lease</h1>
        <div class="header-right">
            <span>Welcome, <strong id="username">Guest</strong></span>
            <button class="btn" onclick="window.location.href='dashboard.html'">Home</button>
            <button class="btn" onclick="window.location.href='bulk_results.html'">Bulk Results</button>
            <button class="btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="form-section">
            <h2>Select Lease and Date Range</h2>
            <div class="form-group">
                <select id="leaseSelect" onchange="onLeaseSelected()">
                    <option value="">Loading leases...</option>
                </select>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label>From Date</label>
                    <input type="date" id="fromDate">
                </div>
                <div class="form-group">
                    <label>To Date</label>
                    <input type="date" id="toDate">
                </div>
            </div>
            <button class="btn" onclick="calculateLease()">Calculate</button>
        </div>

        <div id="results" class="results">
            <div class="summary">
                <h2>üìà Summary</h2>
                <div class="summary-grid" id="summaryGrid"></div>
                <button class="btn" onclick="exportToExcel()" style="margin-top: 20px; background: rgba(255,255,255,0.2);">üì• Export to Excel</button>
            </div>

            <div style="position: relative;">
                <h2 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; margin: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 10px 10px 0 0;">üìÖ Amortization Schedule</h2>
                <div class="scrollable" style="max-height: 600px; overflow-y: auto; overflow-x: auto; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 10px 10px; background: white;">
                    <table id="scheduleTable" style="width: 100%;">
                    <thead>
                        <tr>
                            <th style="padding: 12px; text-align: left; color: white; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">Date</th>
                            <th style="padding: 12px; text-align: right; color: white; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">Rental</th>
                            <th style="padding: 12px; text-align: right; color: white; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">Principal</th>
                            <th style="padding: 12px; text-align: right; color: white; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">PV Factor</th>
                            <th style="padding: 12px; text-align: right; color: white; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">Interest</th>
                            <th style="padding: 12px; text-align: right; color: white; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">Lease Liability</th>
                            <th style="padding: 12px; text-align: right; color: white; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">Remaining Balance</th>
                            <th style="padding: 12px; text-align: right; color: white; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">PV of Rent</th>
                            <th style="padding: 12px; text-align: right; color: white; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">ROU Asset</th>
                            <th style="padding: 12px; text-align: right; color: white; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">Depreciation</th>
                            <th style="padding: 12px; text-align: right; color: white; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">Change ROU</th>
                            <th style="padding: 12px; text-align: right; color: white; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">Security PV</th>
                            <th style="padding: 12px; text-align: right; color: white; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">ARO Gross</th>
                            <th style="padding: 12px; text-align: right; color: white; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">ARO Interest</th>
                            <th style="padding: 12px; text-align: right; color: white; font-weight: 600; border: 1px solid rgba(255,255,255,0.2);">ARO Provision</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody"></tbody>
                </table>
                </div>
            </div>

            <h2>üìù Journal Entries</h2>
            <div class="scrollable">
                <table id="journalTable">
                    <thead>
                        <tr>
                            <th>Account Code</th>
                            <th>Account Name</th>
                            <th>BS/PL</th>
                            <th>Opening Balance</th>
                            <th>Previous Period</th>
                            <th>Result Period</th>
                            <th>Incremental</th>
                            <th>IFRS Adjustment</th>
                            <th>US-GAAP</th>
                        </tr>
                    </thead>
                    <tbody id="journalBody"></tbody>
                </table>
            </div>
        </div>

        <div id="errorMessage" class="error" style="display: none;"></div>
        <div id="loading" class="loading" style="display: none;">‚è≥ Calculating...</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let currentLeaseId = null;
        let leasesData = {}; // Store lease data for quick lookup

        // Handle lease selection change
        function onLeaseSelected() {
            const leaseId = document.getElementById('leaseSelect').value;
            if (leaseId && leasesData[leaseId]) {
                const lease = leasesData[leaseId];
                // Optionally auto-fill dates from lease
                if (lease.lease_start_date && !document.getElementById('fromDate').value) {
                    document.getElementById('fromDate').value = lease.lease_start_date;
                }
                if (lease.end_date && !document.getElementById('toDate').value) {
                    document.getElementById('toDate').value = lease.end_date;
                }
                currentLeaseId = leaseId;
            }
        }

        // Check for lease_id in URL
        window.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const leaseId = urlParams.get('lease_id');
            
            // Load user info
            try {
                const userResponse = await fetch('http://localhost:5001/api/user', {
                    credentials: 'include'
                });
                
                // Parse response
                let userData = {};
                try {
                    userData = await userResponse.json();
                } catch (parseError) {
                    console.error('Failed to parse user response:', parseError);
                }
                
                const usernameEl = document.getElementById('username');
                if (!usernameEl) {
                    console.error('Username element not found');
                } else if (userResponse.ok && userData.success && userData.user) {
                    // API returns {success: true, user: {username: ...}}
                    usernameEl.textContent = userData.user.username || 'Guest';
                    console.log('‚úÖ User loaded:', userData.user.username);
                } else if (userResponse.status === 401) {
                    console.log('‚ö†Ô∏è Not authenticated (401) - showing Guest');
                    usernameEl.textContent = 'Guest';
                } else if (userData.username) {
                    // Fallback for different response format
                    usernameEl.textContent = userData.username || 'Guest';
                    console.log('‚úÖ User loaded (fallback):', userData.username);
                } else {
                    console.warn('‚ö†Ô∏è Could not extract username from response:', userData);
                    usernameEl.textContent = 'Guest';
                }
            } catch (e) {
                console.error('Error loading user info:', e);
                const usernameEl = document.getElementById('username');
                if (usernameEl) {
                    usernameEl.textContent = 'Guest';
                }
            }

            // Load leases - wait for it to complete before pre-selecting
            await loadLeases();

            // If lease_id in URL, pre-select it and optionally load lease data
            if (leaseId) {
                currentLeaseId = leaseId;
                // Wait a bit for dropdown to be populated, then set value
                setTimeout(() => {
                    const select = document.getElementById('leaseSelect');
                    if (select) {
                        select.value = leaseId;
                        // Trigger change event to optionally load lease details
                        select.dispatchEvent(new Event('change'));
                    }
                }, 100);
            }
        });

        async function loadLeases() {
            try {
                const response = await fetch('http://localhost:5001/api/leases', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Authentication required. Please login.');
                    }
                    throw new Error(`Failed to load leases: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const select = document.getElementById('leaseSelect');
                
                // Handle different response formats
                let leases = [];
                if (Array.isArray(data)) {
                    leases = data;
                } else if (data.leases && Array.isArray(data.leases)) {
                    leases = data.leases;
                } else if (data.success && Array.isArray(data.data)) {
                    leases = data.data;
                } else {
                    console.error('Unexpected leases response format:', data);
                    throw new Error('Invalid response format from server');
                }
                
                select.innerHTML = '<option value="">Select a lease...</option>';
                
                if (leases.length === 0) {
                    select.innerHTML = '<option value="">No leases found</option>';
                } else {
                leases.forEach(lease => {
                    const option = document.createElement('option');
                    option.value = lease.lease_id;
                    option.textContent = `${lease.lease_name || 'Lease_' + lease.lease_id} - ${lease.asset_id_code || 'N/A'}`;
                    select.appendChild(option);
                        // Store lease data for quick lookup
                        leasesData[lease.lease_id] = lease;
                    });
                    
                    // If lease_id was in URL, make sure it's selected after dropdown is populated
                    const urlParams = new URLSearchParams(window.location.search);
                    const urlLeaseId = urlParams.get('lease_id');
                    if (urlLeaseId) {
                        // Check if the lease exists in the dropdown
                        if (select.querySelector(`option[value="${urlLeaseId}"]`)) {
                            select.value = urlLeaseId;
                            currentLeaseId = urlLeaseId;
                            // Trigger selection handler to auto-fill dates
                            onLeaseSelected();
                            console.log('‚úÖ Pre-selected lease from URL:', urlLeaseId);
                        } else {
                            console.warn(`‚ö†Ô∏è Lease ID ${urlLeaseId} from URL not found in user's leases`);
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading leases:', error);
                const select = document.getElementById('leaseSelect');
                if (select) {
                    select.innerHTML = `<option value="">Error loading leases: ${error.message}</option>`;
                }
                // Show error message if authentication failed
                if (error.message.includes('401') || error.message.includes('Authentication')) {
                    showError('Please login to view your leases. Redirecting to login...');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                }
            }
        }

        function mapLeaseToCalculation(lease) {
            // Helper to ensure date is valid
            function ensureDate(dateValue, fallback = null) {
                if (!dateValue || dateValue === 'null' || dateValue === 'N/A') {
                    return fallback || new Date().toISOString().split('T')[0];
                }
                if (typeof dateValue === 'string' && dateValue.includes('T')) {
                    return dateValue.split('T')[0];
                }
                return dateValue;
            }

            return {
                auto_id: lease.lease_id || lease.auto_id,
                description: lease.description || '',
                asset_class: lease.asset_class || '',
                asset_id_code: lease.asset_id_code || '',
                lease_start_date: ensureDate(lease.lease_start_date),
                first_payment_date: ensureDate(lease.first_payment_date, lease.lease_start_date),
                end_date: ensureDate(lease.end_date),
                agreement_date: ensureDate(lease.agreement_date),
                termination_date: ensureDate(lease.termination_date),
                date_modified: ensureDate(lease.date_modified),
                tenure: lease.tenure || 0,
                frequency_months: lease.frequency_months || 1,
                day_of_month: lease.day_of_month || '1',
                accrual_day: lease.accrual_day || 1,
                auto_rentals: lease.auto_rentals || 'Yes',
                manual_adj: lease.manual_adj || 'No',
                // CRITICAL: Handle null/undefined but preserve 0 if explicitly set
                rental_1: (lease.rental_1 !== null && lease.rental_1 !== undefined) ? (lease.rental_1 || 0) : 0,
                rental_2: (lease.rental_2 !== null && lease.rental_2 !== undefined) ? (lease.rental_2 || 0) : 0,
                escalation_start_date: ensureDate(lease.escalation_start_date),
                escalation_percent: lease.escalation_percent || 0,
                esc_freq_months: lease.esc_freq_months || lease.esc_freq_months || 12,
                index_rate_table: lease.index_rate_table || '',
                borrowing_rate: lease.borrowing_rate || 8,
                compound_months: lease.compound_months || 12,
                fv_of_rou: lease.fv_of_rou || 0,
                currency: lease.currency || 'USD',
                cost_centre: lease.cost_centre || '',
                counterparty: lease.counterparty || '',
                security_deposit: lease.security_deposit || 0,
                security_discount: lease.security_discount || 0,
                aro: lease.aro || 0,
                aro_table: lease.aro_table || 0,
                initial_direct_expenditure: lease.initial_direct_expenditure || 0,
                lease_incentive: lease.lease_incentive || 0,
                sublease: lease.sublease || 'No',
                sublease_rou: lease.sublease_rou || 0,
                finance_lease: lease.finance_lease_usgaap || 'No',
                short_term_ifrs: lease.shortterm_lease_ifrs_indas || 'No',
                bargain_purchase: lease.bargain_purchase || 'No',
                purchase_option_price: lease.purchase_option_price || 0,
                title_transfer: lease.title_transfer || 'No',
                practical_expedient: lease.practical_expedient || 'No',
                transition_option: lease.transition_option || '',
                transition_date: ensureDate(lease.transition_date),
                termination_penalty: lease.termination_penalty || 0,
                // Add all new fields
                useful_life_end_date: ensureDate(lease.useful_life_end_date),
            };
        }

        async function calculateLease() {
            const leaseId = document.getElementById('leaseSelect').value || currentLeaseId;
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;

            if (!leaseId) {
                showError('Please select a lease from the dropdown');
                return;
            }

            if (!fromDate || !toDate) {
                showError('Please enter both From Date and To Date');
                return;
            }
            
            // Validate dates
            if (new Date(fromDate) > new Date(toDate)) {
                showError('From Date must be before To Date');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';

            try {
                // Fetch lease data
                const leaseResponse = await fetch(`http://localhost:5001/api/leases/${leaseId}`, {
                    credentials: 'include'
                });

                if (!leaseResponse.ok) {
                    throw new Error('Failed to load lease data');
                }

                const leaseResponseData = await leaseResponse.json();
                console.log('üìã Lease data from API:', leaseResponseData);
                
                // Extract lease object (API returns {success: true, lease: {...}})
                const lease = leaseResponseData.lease || leaseResponseData;
                console.log('üìã Extracted lease object:', lease);
                console.log('üìã rental_1 value:', lease.rental_1, 'type:', typeof lease.rental_1);
                
                // CRITICAL FIX: Ensure rental_1 is a number
                if (lease.rental_1 !== null && lease.rental_1 !== undefined) {
                    lease.rental_1 = parseFloat(lease.rental_1) || 0;
                } else {
                    lease.rental_1 = 0;
                }
                console.log('üìã rental_1 after parseFloat:', lease.rental_1);
                
                // Map lease to calculation format
                const calculationData = mapLeaseToCalculation(lease);
                console.log('üìã Mapped calculation data:', calculationData);
                console.log('üìã rental_1 after mapping:', calculationData.rental_1);
                calculationData.from_date = fromDate;
                calculationData.to_date = toDate;

                // Calculate
                const response = await fetch('http://localhost:5001/api/calculate_lease', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(calculationData),
                    credentials: 'include'
                });

                // Check response status first
                if (!response.ok) {
                    let errorMsg = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.error || errorMsg;
                    } catch (e) {
                        // Response might not be JSON
                    }
                    console.error('Calculation API error:', errorMsg);
                    showError(errorMsg);
                    return;
                }

                const result = await response.json();

                // Check for error in result
                if (result.error) {
                    console.error('Calculation error:', result.error);
                    showError(result.error || 'Calculation failed');
                    return;
                }

                // Success case - API returns result directly, not wrapped in success
                displayResults(result);
            } catch (error) {
                console.error('Calculation error:', error);
                showError(`Error: ${error.message || 'Failed to connect to server. Please check if the server is running.'}`);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayResults(result) {
            const lr = result.lease_result || {};
            
            // Display summary with ALL available data
            const summaryGrid = document.getElementById('summaryGrid');
            summaryGrid.innerHTML = `
                <!-- Lease Information -->
                <div class="summary-item" style="grid-column: 1 / -1; background: rgba(255,255,255,0.15); padding: 20px; border-radius: 8px;">
                    <h3 style="margin-bottom: 10px; font-size: 1.1rem;">Lease Information</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <div><strong>Description:</strong> ${lr.description || 'N/A'}</div>
                        <div><strong>Asset Code:</strong> ${lr.asset_code || 'N/A'}</div>
                        <div><strong>Asset Class:</strong> ${lr.asset_class || 'N/A'}</div>
                        <div><strong>Cost Center:</strong> ${lr.cost_center || 'N/A'}</div>
                        <div><strong>Currency:</strong> ${lr.currency || 'USD'}</div>
                        <div><strong>Borrowing Rate:</strong> ${lr.borrowing_rate ? (lr.borrowing_rate.toFixed(2) + '%') : 'N/A'}</div>
                    </div>
                </div>
                
                <!-- Opening Balances (Collapsible) -->
                <div class="summary-item" style="grid-column: 1 / -1; background: rgba(102, 126, 234, 0.15); padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid rgba(102, 126, 234, 0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleOpeningBalances()">
                        <h3 style="margin: 0; font-size: 1rem; color: #ffffff; font-weight: 600;">üìä Opening Balances</h3>
                        <button id="openingBalancesToggle" style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; font-weight: 500;">
                            Show Details
                        </button>
                    </div>
                    
                    <!-- Summary (Always Visible) -->
                    <div style="margin-top: 12px; padding: 10px; background: rgba(255, 255, 255, 0.15); border-radius: 6px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 0.9rem;">
                            <div>
                                <strong style="color: #ffffff; opacity: 0.9;">Lease Liability:</strong>
                                <span style="color: #ffffff; font-weight: 700; display: block; margin-top: 4px; font-size: 1rem;">$${formatCurrency(lr.opening_lease_liability || 0)}</span>
                            </div>
                            <div>
                                <strong style="color: #ffffff; opacity: 0.9;">ROU Asset:</strong>
                                <span style="color: #ffffff; font-weight: 700; display: block; margin-top: 4px; font-size: 1rem;">$${formatCurrency(lr.opening_rou_asset || 0)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed View (Collapsed by Default) -->
                    <div id="openingBalancesDetails" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 2px solid rgba(255, 255, 255, 0.3);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 0.9rem;">
                            <div>
                                <strong style="color: #ffffff; opacity: 0.9;">Lease Liability:</strong>
                                <span style="color: #ffffff; font-weight: 700; display: block; margin-top: 4px; font-size: 1rem;">$${formatCurrency(lr.opening_lease_liability || 0)}</span>
                            </div>
                            <div>
                                <strong style="color: #ffffff; opacity: 0.9;">ROU Asset:</strong>
                                <span style="color: #ffffff; font-weight: 700; display: block; margin-top: 4px; font-size: 1rem;">$${formatCurrency(lr.opening_rou_asset || 0)}</span>
                            </div>
                            <div>
                                <strong style="color: #ffffff; opacity: 0.9;">ARO Liability:</strong>
                                <span style="color: #ffffff; font-weight: 700; display: block; margin-top: 4px; font-size: 1rem;">$${formatCurrency(lr.opening_aro_liability || 0)}</span>
                            </div>
                            <div>
                                <strong style="color: #ffffff; opacity: 0.9;">Security Deposit:</strong>
                                <span style="color: #ffffff; font-weight: 700; display: block; margin-top: 4px; font-size: 1rem;">$${formatCurrency(lr.opening_security_deposit || 0)}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Period Activity -->
                <div class="summary-item">
                    <strong>Total Interest</strong>
                    <span>$${formatCurrency(lr.interest_expense || 0)}</span>
                </div>
                <div class="summary-item">
                    <strong>Total Depreciation</strong>
                    <span>$${formatCurrency(lr.depreciation_expense || 0)}</span>
                </div>
                <div class="summary-item">
                    <strong>Total Rent Paid</strong>
                    <span>$${formatCurrency(lr.rent_paid || 0)}</span>
                </div>
                <div class="summary-item">
                    <strong>ARO Interest</strong>
                    <span>$${formatCurrency(lr.aro_interest || 0)}</span>
                </div>
                <div class="summary-item">
                    <strong>Security Deposit Interest</strong>
                    <span>$${formatCurrency(lr.security_deposit_change || 0)}</span>
                </div>
                <div class="summary-item">
                    <strong>Total Payments</strong>
                    <span>${result.schedule ? result.schedule.filter(r => r.rental_amount && r.rental_amount > 0).length : 0}</span>
                </div>
                
                <!-- Closing Balances -->
                <div class="summary-item" style="grid-column: 1 / -1; background: rgba(118, 75, 162, 0.2); padding: 15px; border-radius: 8px; margin-top: 10px;">
                    <h3 style="margin-bottom: 10px; font-size: 1rem;">üí∞ Closing Balances</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                        <div><strong>Lease Liability (Total):</strong> <span>$${formatCurrency((lr.closing_lease_liability_non_current || 0) + (lr.closing_lease_liability_current || 0))}</span></div>
                        <div><strong>Lease Liability (Non-Current):</strong> <span>$${formatCurrency(lr.closing_lease_liability_non_current || 0)}</span></div>
                        <div><strong>Lease Liability (Current):</strong> <span>$${formatCurrency(lr.closing_lease_liability_current || 0)}</span></div>
                        <div><strong>ROU Asset:</strong> <span>$${formatCurrency(lr.closing_rou_asset || 0)}</span></div>
                        <div><strong>ARO Liability:</strong> <span>$${formatCurrency(lr.closing_aro_liability || 0)}</span></div>
                        <div><strong>Security Deposit:</strong> <span>$${formatCurrency(lr.closing_security_deposit || 0)}</span></div>
                    </div>
                </div>
                
                <!-- Gain/Loss & Other -->
                <div class="summary-item">
                    <strong>Gain/(Loss) P&L</strong>
                    <span style="color: ${(lr.gain_loss_pnl || 0) >= 0 ? '#4caf50' : '#f44336'}">
                        $${formatCurrency(lr.gain_loss_pnl || 0)}
                    </span>
                </div>
                <div class="summary-item">
                    <strong>Remaining ROU Life</strong>
                    <span>${lr.remaining_rou_life ? Math.round(lr.remaining_rou_life) + ' days' : 'N/A'}</span>
                </div>
                
                <!-- Future Projections Section (Collapsible) -->
                ${(lr.projections && lr.projections.length > 0) ? `
                <div class="summary-item" style="grid-column: 1 / -1; background: rgba(102, 126, 234, 0.15); padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid rgba(102, 126, 234, 0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleProjections()">
                        <h3 style="margin: 0; font-size: 1.1rem; color: #ffffff; font-weight: 600;">
                            üìà Future Projections 
                            <span style="font-size: 0.85rem; color: #ffffff; opacity: 0.85; font-weight: 400;">(${lr.projections.length} period${lr.projections.length > 1 ? 's' : ''})</span>
                        </h3>
                        <button id="projectionsToggle" style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; font-weight: 500;">
                            Show Details
                        </button>
                    </div>
                    
                    <!-- Summary (Always Visible) -->
                    <div style="margin-top: 15px; padding: 12px; background: rgba(255, 255, 255, 0.15); border-radius: 6px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; font-size: 0.9rem;">
                            <div>
                                <strong style="color: #ffffff; opacity: 0.9; font-size: 0.85rem; display: block; margin-bottom: 4px;">Next Period:</strong>
                                <span style="color: #ffffff; font-weight: 700; font-size: 0.95rem;">${formatDate(lr.projections[0].projection_date)}</span>
                            </div>
                            <div>
                                <strong style="color: #ffffff; opacity: 0.9; font-size: 0.85rem; display: block; margin-bottom: 4px;">Liability:</strong>
                                <span style="color: #ffffff; font-weight: 700; font-size: 0.95rem;">$${formatCurrency(lr.projections[0].closing_liability || 0)}</span>
                            </div>
                            <div>
                                <strong style="color: #ffffff; opacity: 0.9; font-size: 0.85rem; display: block; margin-bottom: 4px;">ROU Asset:</strong>
                                <span style="color: #ffffff; font-weight: 700; font-size: 0.95rem;">$${formatCurrency(lr.projections[0].closing_rou_asset || 0)}</span>
                            </div>
                            <div>
                                <strong style="color: #ffffff; opacity: 0.9; font-size: 0.85rem; display: block; margin-bottom: 4px;">Total Rent:</strong>
                                <span style="color: #ffffff; font-weight: 700; font-size: 0.95rem;">$${formatCurrency(lr.projections.reduce((sum, p) => sum + (p.rent_paid || 0), 0))}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Table (Collapsed by Default) - Responsive -->
                    <div id="projectionsDetails" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(102, 126, 234, 0.2); overflow-x: auto;">
                        <div style="min-width: 100%; overflow-x: auto;">
                            <table style="width: 100%; min-width: 800px; border-collapse: collapse; font-size: 0.9rem; background: white;">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                        <th style="padding: 12px; text-align: left; border: 1px solid #ddd; color: white; font-weight: 600; white-space: nowrap;">Period</th>
                                        <th style="padding: 12px; text-align: left; border: 1px solid #ddd; color: white; font-weight: 600; white-space: nowrap;">Projection Date</th>
                                        <th style="padding: 12px; text-align: right; border: 1px solid #ddd; color: white; font-weight: 600; white-space: nowrap;">Closing Liability</th>
                                        <th style="padding: 12px; text-align: right; border: 1px solid #ddd; color: white; font-weight: 600; white-space: nowrap;">Closing ROU Asset</th>
                                        <th style="padding: 12px; text-align: right; border: 1px solid #ddd; color: white; font-weight: 600; white-space: nowrap;">Depreciation</th>
                                        <th style="padding: 12px; text-align: right; border: 1px solid #ddd; color: white; font-weight: 600; white-space: nowrap;">Interest</th>
                                        <th style="padding: 12px; text-align: right; border: 1px solid #ddd; color: white; font-weight: 600; white-space: nowrap;">Rent Paid</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${lr.projections.map((proj, idx) => {
                                        const bgColor = idx % 2 === 0 ? '#f8f9ff' : '#ffffff';
                                        const rowColor = idx % 2 === 0 ? '#667eea' : '#764ba2';
                                        return `
                                            <tr style="background-color: ${bgColor};">
                                                <td style="padding: 10px; border: 1px solid #e0e0e0; font-weight: 600; color: ${rowColor}; white-space: nowrap;">
                                                    Period ${proj.projection_mode || (idx + 1)}
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #e0e0e0; color: #333; font-weight: 500; white-space: nowrap;">
                                                    ${formatDate(proj.projection_date)}
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #e0e0e0; text-align: right; color: #1e40af; font-weight: 700; font-size: 0.95rem; white-space: nowrap;">
                                                    $${formatCurrency(proj.closing_liability || 0)}
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #e0e0e0; text-align: right; color: #1e40af; font-weight: 700; font-size: 0.95rem; white-space: nowrap;">
                                                    $${formatCurrency(proj.closing_rou_asset || 0)}
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #e0e0e0; text-align: right; color: #b91c1c; font-weight: 600; font-size: 0.95rem; white-space: nowrap;">
                                                    $${formatCurrency(proj.depreciation || 0)}
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #e0e0e0; text-align: right; color: #b91c1c; font-weight: 600; font-size: 0.95rem; white-space: nowrap;">
                                                    $${formatCurrency(proj.interest || 0)}
                                                </td>
                                                <td style="padding: 10px; border: 1px solid #e0e0e0; text-align: right; color: #047857; font-weight: 700; font-size: 0.95rem; white-space: nowrap;">
                                                    $${formatCurrency(proj.rent_paid || 0)}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;

            // Display schedule with ALL columns including Principal and Remaining Balance
            const scheduleBody = document.getElementById('scheduleBody');
            scheduleBody.innerHTML = result.schedule.map((row, idx) => {
                const bgColor = idx % 2 === 0 ? '#f8f9fa' : '#ffffff';
                // Highlight opening/closing rows
                const rowStyle = idx === 0 ? 'background-color: #e3f2fd; font-weight: 500;' : 
                                idx === result.schedule.length - 1 ? 'background-color: #fff3e0; font-weight: 500;' : 
                                `background-color: ${bgColor};`;
                
                return `
                <tr style="${rowStyle}">
                    <td style="padding: 8px; border: 1px solid #ddd;">${formatDate(row.date)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${formatCurrency(row.rental_amount || 0)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${formatCurrency(row.principal || 0)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${(row.pv_factor || 0).toFixed(6)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${formatCurrency(row.interest || 0)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right; font-weight: ${idx === 0 || idx === result.schedule.length - 1 ? '600' : '400'};">
                        $${formatCurrency(row.lease_liability || 0)}
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${row.remaining_balance !== null && row.remaining_balance !== undefined ? '$' + formatCurrency(row.remaining_balance) : '-'}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${formatCurrency(row.pv_of_rent || 0)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right; font-weight: ${idx === 0 || idx === result.schedule.length - 1 ? '600' : '400'};">
                        $${formatCurrency(row.rou_asset || 0)}
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${formatCurrency(row.depreciation || 0)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${formatCurrency(row.change_in_rou || 0)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${formatCurrency(row.security_deposit_pv || 0)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${row.aro_gross !== null && row.aro_gross !== undefined ? '$' + formatCurrency(row.aro_gross) : '-'}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${row.aro_interest !== null && row.aro_interest !== undefined ? '$' + formatCurrency(row.aro_interest) : '-'}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${row.aro_provision !== null && row.aro_provision !== undefined ? '$' + formatCurrency(row.aro_provision) : '-'}</td>
                </tr>
            `;
            }).join('');

            // Display journal entries with Opening Balance and IFRS/US-GAAP columns
            const journalBody = document.getElementById('journalBody');
            journalBody.innerHTML = result.journal_entries.map((entry, idx) => {
                // Check if entry has opening_balance field (new feature)
                const openingBal = entry.opening_balance !== undefined ? entry.opening_balance : entry.previous_period;
                const ifrsAdj = entry.ifrs_adjustment !== undefined ? entry.ifrs_adjustment : (entry.result_period || 0);
                const usgaapEntry = entry.usgaap_entry !== undefined ? entry.usgaap_entry : 0;
                const bgColor = idx % 2 === 0 ? '#f8f9fa' : '#ffffff';
                return `
                <tr style="background-color: ${bgColor};">
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 500;">${entry.account_code || '-'}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: left;">${entry.account_name || ''}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: 500;">${entry.bs_pl || ''}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${formatCurrency(openingBal || 0)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${formatCurrency(entry.previous_period || 0)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${formatCurrency(entry.result_period || 0)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right; font-weight: 500;">$${formatCurrency(entry.incremental_adjustment || 0)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${formatCurrency(ifrsAdj || 0)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${formatCurrency(usgaapEntry || 0)}</td>
                </tr>
            `;
            }).join('');

            // Projections are now included directly in summaryGrid HTML above
            // Log projections for debugging
            console.log('üìä Projections data:', result.lease_result?.projections);

            document.getElementById('results').style.display = 'block';
        }

        // Toggle function for projections details
        function toggleProjections() {
            const detailsDiv = document.getElementById('projectionsDetails');
            const toggleBtn = document.getElementById('projectionsToggle');
            
            if (detailsDiv && toggleBtn) {
                if (detailsDiv.style.display === 'none') {
                    detailsDiv.style.display = 'block';
                    toggleBtn.textContent = 'Hide Details';
                    toggleBtn.style.background = '#dc2626';
                } else {
                    detailsDiv.style.display = 'none';
                    toggleBtn.textContent = 'Show Details';
                    toggleBtn.style.background = '#667eea';
                }
            }
        }
        
        // Toggle function for opening balances details
        function toggleOpeningBalances() {
            const detailsDiv = document.getElementById('openingBalancesDetails');
            const toggleBtn = document.getElementById('openingBalancesToggle');
            
            if (detailsDiv && toggleBtn) {
                if (detailsDiv.style.display === 'none') {
                    detailsDiv.style.display = 'block';
                    toggleBtn.textContent = 'Hide Details';
                    toggleBtn.style.background = '#dc2626';
                } else {
                    detailsDiv.style.display = 'none';
                    toggleBtn.textContent = 'Show Details';
                    toggleBtn.style.background = '#667eea';
                }
            }
        }
        // This ensures the heading and table always appear together when projections exist

        function formatCurrency(value) {
            return Math.abs(value || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function exportToExcel() {
            const today = new Date();
            
            // Get data from displayed tables
            const scheduleData = Array.from(document.querySelectorAll('#scheduleBody tr')).map(row => {
                const cells = row.querySelectorAll('td');
                return {
                    'Date': cells[0].textContent,
                    'Rental': cells[1].textContent,
                    'Principal': cells[2].textContent,
                    'PV Factor': cells[3].textContent,
                    'Interest': cells[4].textContent,
                    'Lease Liability': cells[5].textContent,
                    'Remaining Balance': cells[6].textContent,
                    'PV of Rent': cells[7].textContent,
                    'ROU Asset': cells[8].textContent,
                    'Depreciation': cells[9].textContent,
                    'Change ROU': cells[10].textContent,
                    'Security PV': cells[11].textContent,
                    'ARO Gross': cells[12].textContent,
                    'ARO Interest': cells[13].textContent,
                    'ARO Provision': cells[14].textContent
                };
            });

            const journalData = Array.from(document.querySelectorAll('#journalBody tr')).map(row => {
                const cells = row.querySelectorAll('td');
                return {
                    'Account Code': cells[0].textContent,
                    'Account Name': cells[1].textContent,
                    'BS/PL': cells[2].textContent,
                    'Result Period': cells[3].textContent,
                    'Previous Period': cells[4].textContent,
                    'Incremental': cells[5].textContent,
                    'US-GAAP': cells[6].textContent,
                    'IFRS Adjustment': cells[7].textContent
                };
            });
            
            // Get summary data from displayed HTML (using <strong> and <span> tags)
            const summaryValues = {};
            document.querySelectorAll('#summaryGrid .summary-item').forEach(item => {
                const strong = item.querySelector('strong');
                const span = item.querySelector('span');
                if (strong && span) {
                    const label = strong.textContent.trim();
                    const value = span.textContent.trim();
                    // Skip items with specific styling (grid-column, etc.)
                    const hasGridColumn = item.style.gridColumn || item.getAttribute('style')?.includes('grid-column');
                    if (!hasGridColumn && label && value) {
                        summaryValues[label] = value;
                    }
                }
            });

            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // 1. ENHANCED Summary Sheet
            const summarySheetData = [
                ['LEASE CALCULATION SUMMARY REPORT'],
                [],
                ['Report Information'],
                ['Generated Date', today.toLocaleDateString() + ' ' + today.toLocaleTimeString()],
                [],
                ['Financial Summary'],
                ...Object.entries(summaryValues).map(([label, value]) => [label, value]),
            ];
            const wsSummary = XLSX.utils.aoa_to_sheet(summarySheetData);
            wsSummary['!cols'] = [{ wch: 30 }, { wch: 22 }];
            XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');
            
            // 2. Schedule Sheet with formatting
            const wsSchedule = XLSX.utils.json_to_sheet(scheduleData);
            wsSchedule['!cols'] = [
                { wch: 12 }, { wch: 15 }, { wch: 12 }, { wch: 12 }, { wch: 15 },
                { wch: 18 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 },
                { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }
            ];
            XLSX.utils.book_append_sheet(wb, wsSchedule, 'Schedule');
            
            // 3. Journal Entries Sheet with formatting
            const wsJournal = XLSX.utils.json_to_sheet(journalData);
            wsJournal['!cols'] = [{ wch: 12 }, { wch: 35 }, { wch: 8 }, { wch: 18 }, { wch: 18 }, { wch: 18 }, { wch: 18 }, { wch: 18 }];
            XLSX.utils.book_append_sheet(wb, wsJournal, 'Journal Entries');

            // Download with timestamp
            const timestamp = today.toISOString().split('T')[0].replace(/-/g, '');
            const leaseId = document.getElementById('leaseSelect').value;
            const filename = `Lease_${leaseId}_${timestamp}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            alert('‚úÖ Enhanced Excel report downloaded!\n\nFile: ' + filename + '\n\nContains:\n‚Ä¢ Professional summary with metadata\n‚Ä¢ Amortization schedule\n‚Ä¢ Journal entries\n‚Ä¢ Timestamped filename');
        }

        async function logout() {
            try {
                await fetch('http://localhost:5001/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = 'login.html';
            } catch (error) {
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>


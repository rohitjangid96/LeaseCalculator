<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Lease Accounting Form</title>
    <!-- Excel Export Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Progress Bar Library -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.css"/>
    <script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.js"></script>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        /* Form-specific overrides for Trullion design */
        body {
            background: var(--color-bg-light);
        }
        .header {
            background: var(--color-brand-green);
            color: white !important;
        }
        .header h1 {
            font-size: 1.5rem !important;
            color: white !important;
        }
        .header .user-info {
            color: white !important;
        }
        .container {
            box-shadow: var(--shadow-lg);
        }
        header {
            background: var(--color-bg-light);
            border-bottom: 1px solid var(--color-border-sage);
        }
        header h1 {
            font-size: 1.5rem !important;
            color: var(--color-text-primary) !important;
        }
        .content { padding: var(--spacing-xl); }
        
        /* Smaller Result Headings */
        .results h2,
        .results h3,
        h2,
        h3 {
            font-size: 1.125rem !important;  /* Make headings smaller */
            font-weight: 600;
        }
        
        /* Large Save Button */
        .btn-primary {
            padding: 1rem 2rem !important;
            font-size: 1.125rem !important;
        }
        
        /* Better Checkbox Toggle Styling */
        .switch-toggle {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--color-bg-light);
            border: 1px solid var(--color-border-sage);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
            transition: var(--transition-base);
        }
        .switch-toggle:hover {
            background: var(--color-sage-1);
        }
        .switch-toggle label:first-child {
            flex: 1;
            font-weight: 600;
            color: var(--color-text-primary);
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--color-brand-green);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .switch-toggle > span {
            font-weight: 600;
            color: var(--color-text-secondary);
        }
        
        /* Tab System */
        .tabs {
            display: flex;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-lg);
            border-bottom: 2px solid var(--color-border-sage);
        }
        .tab {
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--color-sage-1);
            color: var(--color-text-secondary);
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: var(--transition-base);
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        }
        .tab:hover {
            background: var(--color-sage-2);
        }
        .tab.active {
            background: white;
            border-bottom-color: var(--color-brand-green);
            color: var(--color-brand-green);
        }
        
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        .conditional-field {
            border-left: 3px solid var(--color-brand-green);
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
            transition: var(--transition-base);
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .results {
            background: var(--color-bg-light);
        }
        
        /* Override table headers to use sage */
        table thead,
        table thead th,
        thead tr {
            background: var(--color-sage-1) !important;
            color: var(--color-text-primary) !important;
        }
        
        /* Override purple/violet colors */
        button[style*="#667eea"],
        button[style*="background: #667eea"] {
            background: var(--color-brand-green) !important;
        }
        
        /* Custom Notification System */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }
        
        .notification {
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            opacity: 0;
            transform: translateX(100%);
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.hide {
            animation: slideOut 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        
        .notification.success {
            background: rgba(169, 255, 155, 0.3);
            border-left: 4px solid var(--color-brand-green);
            color: var(--color-brand-green);
        }
        
        .notification.error {
            background: rgba(255, 217, 190, 0.5);
            border-left: 4px solid #dc2626;
            color: #dc2626;
        }
        
        .notification.warning {
            background: rgba(220, 255, 121, 0.3);
            border-left: 4px solid #b8860b;
            color: #b8860b;
        }
        
        .notification.info {
            background: rgba(160, 255, 229, 0.2);
            border-left: 4px solid #36b0b0;
            color: var(--color-brand-black);
        }
        
        .notification-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 2px;
        }
        
        .notification-message {
            font-size: 0.85rem;
            opacity: 0.95;
            line-height: 1.4;
        }
        
        .notification-close {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: inherit;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        
        .notification-close:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        /* NProgress Customization (Trullion green) */
        #nprogress .bar {
            background: var(--color-brand-green) !important;
            height: 3px !important;
        }
        
        #nprogress .peg {
            box-shadow: 0 0 10px var(--color-brand-green), 0 0 5px var(--color-brand-green) !important;
        }
        
        #nprogress .spinner-icon {
            border-top-color: var(--color-brand-green) !important;
            border-left-color: var(--color-brand-green) !important;
        }
    </style>
</head>
<body>
    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>
    
    <div class="header">
        <h1>üè¢ Lease Management System</h1>
        <div class="user-info">
            <span>Welcome, <strong id="username">User</strong></span>
            <button class="btn" onclick="window.location.href='dashboard.html'">üè† Home</button>
            <button class="btn" onclick="logout()">Logout</button>
        </div>
    </div>
    
    <div class="container">
        <header>
            <h1>üè¢ Complete Lease Accounting Form</h1>
            <p style="opacity: 0.9;">All fields with conditional formatting</p>
        </header>

        <div class="content">
            <div class="tabs">
                <button class="tab active" onclick="showTab(0)">General</button>
                <button class="tab" onclick="showTab(1)">Dates & Terms</button>
                <button class="tab" onclick="showTab(2)">Rentals</button>
                <button class="tab" onclick="showTab(3)">Financial</button>
                <button class="tab" onclick="showTab(4)">Additional</button>
                <button class="tab" onclick="showTab(5)">Documents</button>
            </div>

            <form id="leaseForm">
                <!-- Tab 1: General Information -->
                <div class="tab-content active" id="tab0">
                    <!-- AI PDF Extraction Section -->
                    <div style="background: var(--color-sage-1); border: 1px solid var(--color-border-sage); color: var(--color-text-primary); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--color-text-primary);">ü§ñ AI-Assisted Data Entry</h3>
                        <p style="margin-bottom: 15px; font-size: 0.9rem; opacity: 0.9; color: var(--color-text-secondary);">Upload a PDF lease document and let AI automatically fill the form for you!</p>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="file" id="pdfFileInput" accept=".pdf" style="flex: 1; min-width: 200px; padding: 10px; border-radius: 6px; border: 2px dashed var(--color-border-sage-strong); background: white; color: var(--color-text-primary);" />
                            <input type="text" id="apiKeyInput" placeholder="Google AI API Key (optional)" style="flex: 1; min-width: 200px; padding: 10px; border-radius: 6px; border: 1px solid var(--color-border-sage); background: white; color: var(--color-text-primary);" />
                            <button type="button" onclick="extractFromPdf()" style="padding: 10px 20px; background: var(--color-brand-green); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s;">üöÄ Extract with AI</button>
                        </div>
                        <div id="extractionStatus" style="margin-top: 10px; font-size: 0.85rem; color: var(--color-text-secondary);"></div>
                        <div style="margin-top: 10px; font-size: 0.75rem; opacity: 0.8; color: var(--color-text-secondary);">
                            üí° Get your free Google AI API key at: <a href="https://makersuite.google.com/app/apikey" target="_blank" style="color: var(--color-brand-green); text-decoration: underline;">https://makersuite.google.com/app/apikey</a>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="asset_name">Asset Name <span class="mandatory">*</span></label>
                        <input type="text" id="asset_name" name="Asset_Name" value="" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" name="Description" rows="3"></textarea>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label for="asset_class">Asset Class <span class="mandatory">*</span></label>
                            <select id="asset_class" name="Asset_class" required>
                                <option value="">Select...</option>
                                <option value="Land">Land</option>
                                <option value="Building">Building</option>
                                <option value="Vehicle">Vehicle</option>
                                <option value="Equipment">Equipment</option>
                                <option value="Plant and Machinery">Plant and Machinery</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="asset_id">Asset ID/Code</label>
                            <input type="text" id="asset_id" name="Asset_ID_Code" value="">
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label for="counterparty">Counterparty</label>
                            <input type="text" id="counterparty" name="Counterparty" value="">
                        </div>
                        <div class="form-group">
                            <label for="entity_name">Group Entity Name</label>
                            <input type="text" id="entity_name" name="Group_entity_name" value="">
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label for="region">Region</label>
                            <input type="text" id="region" name="Region" value="">
                        </div>
                        <div class="form-group">
                            <label for="segment">Segment</label>
                            <input type="text" id="segment" name="Segment" value="">
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label for="cost_element">Cost Element</label>
                            <input type="text" id="cost_element" name="Cost_element" value="">
                        </div>
                        <div class="form-group">
                            <label for="vendor_code">Vendor Code</label>
                            <input type="text" id="vendor_code" name="Vendor_code" value="">
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label for="agreement_type">Agreement Type</label>
                            <input type="text" id="agreement_type" name="Agreement_type" value="">
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label for="resp_ops">Responsible Person - Operations</label>
                            <input type="text" id="resp_ops" name="Responsible_person_Operations" value="">
                        </div>
                        <div class="form-group">
                            <label for="resp_accounts">Responsible Person - Accounts</label>
                            <input type="text" id="resp_accounts" name="Responsible_person_Accounts" value="">
                        </div>
                    </div>
                </div>

                <!-- Tab 2: Dates & Terms -->
                <div class="tab-content" id="tab1">
                    <div class="two-column">
                        <div class="form-group">
                            <label for="lease_start">Lease Start Date <span class="mandatory">*</span></label>
                            <input type="date" id="lease_start" name="Lease_start_date" value="" required>
                        </div>
                        <div class="form-group">
                            <label for="first_payment">First Payment Date <span class="mandatory">*</span></label>
                            <input type="date" id="first_payment" name="First_payment_date" value="" required>
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label for="end_date">Lease End Date <span class="mandatory">*</span></label>
                            <input type="date" id="end_date" name="End_date" value="" required>
                        </div>
                        <div class="form-group">
                            <label for="agreement_date">Agreement Date</label>
                            <input type="date" id="agreement_date" name="Agreement_date" value="">
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label for="termination_date">Termination Date</label>
                            <input type="date" id="termination_date" name="Termination_date" value="">
                        </div>
                        <div class="form-group">
                            <label for="termination_penalty">Termination Penalty</label>
                            <input type="number" id="termination_penalty" name="Termination_penalty" step="0.01" value="">
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label for="tenure">Tenure (Months)</label>
                            <input type="number" id="tenure" name="Tenure" step="0.1" value="">
                        </div>
                        <div class="form-group">
                            <label for="accrual_day">Rent Accrual Day <span class="mandatory">*</span></label>
                            <input type="number" id="accrual_day" name="Accrual_day" min="1" max="31" value="" required>
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label for="frequency">Rental Frequency (Months) <span class="mandatory">*</span></label>
                            <select id="frequency" name="Frequency_months" required>
                                <option value="">Select...</option>
                                <option value="1">Monthly</option>
                                <option value="3">Quarterly</option>
                                <option value="6">Semi-annually</option>
                                <option value="12">Annually</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="day_of_month">Day of Month <span class="mandatory">*</span></label>
                            <select id="day_of_month" name="Day_of_Month" required>
                                <option value="">Select...</option>
                                <option value="Last">Last Day</option>
                                <!-- Days 1-31 will be added dynamically -->
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Tab 3: Rentals with Conditional Logic -->
                <div class="tab-content" id="tab2">
                    <!-- Auto Rentals Toggle -->
                    <div class="switch-toggle">
                        <label for="auto_rentals">Auto Rentals</label>
                        <label class="switch">
                            <input type="checkbox" id="auto_rentals" name="Auto_rentals" onchange="toggleAutoRentals()">
                            <span class="slider"></span>
                        </label>
                        <span id="auto_label" style="font-weight: bold; margin-left: 10px; color: #6c757d;">No</span>
                    </div>

                    <!-- Auto Rental Field -->
                    <div id="auto_rental_field" class="form-group" style="display: none;">
                        <label for="rental_amount">Rental Amount <span class="mandatory">*</span></label>
                        <input type="number" id="rental_amount" name="Rental_1" step="0.01" min="0" value="" required>
                    </div>

                    <!-- Escalation Toggle -->
                    <div class="switch-toggle" id="escalation_toggle" style="display: flex;">
                        <label for="escalation">Static Escalation</label>
                        <label class="switch">
                            <input type="checkbox" id="escalation" onchange="toggleEscalation()">
                            <span class="slider"></span>
                        </label>
                        <span id="escalation_label" style="font-weight: bold; margin-left: 10px; color: #6c757d;">No</span>
                    </div>

                    <!-- Escalation Fields -->
                    <div id="escalation_fields" class="conditional-field" style="display: none;">
                        <div class="two-column">
                            <div class="form-group">
                                <label for="escalation_start">Escalation Start Date</label>
                                <input type="date" id="escalation_start" name="Escalation_Start" value="">
                                <!-- Hidden field for mapping -->
                                <input type="hidden" id="escalation_start_date" name="escalation_start_date" value="">
                            </div>
                            <div class="form-group">
                                <label for="escalation_percent">Escalation Percentage (%)</label>
                                <input type="number" id="escalation_percent" name="Escalation_percent" step="0.01" value="">
                            </div>
                        </div>
                        <div class="two-column">
                            <div class="form-group">
                                <label for="esc_freq">Escalation Frequency (Months)</label>
                                <input type="number" id="esc_freq" name="Esc_Freq_months" min="1" value="">
                                <!-- Also add mapping for backend -->
                                <input type="hidden" id="esc_freq_months" name="esc_freq_months" value="">
                            </div>
                            <div class="form-group">
                                <label for="index_rate_table">Index/Rate Table</label>
                                <input type="number" id="index_rate_table" name="Index_rate_table" step="0.01" value="">
                                <span class="help-text">For variable rate leases</span>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Adjustment Toggle -->
                    <div class="switch-toggle" id="manual_toggle" style="display: flex;">
                        <label for="manual_adj">Manual Adjustments</label>
                        <label class="switch">
                            <input type="checkbox" id="manual_adj" name="Manual_Adj" onchange="toggleManualAdj()">
                            <span class="slider"></span>
                        </label>
                        <span id="manual_label" style="font-weight: bold; margin-left: 10px; color: #6c757d;">No</span>
                    </div>

                    <!-- Manual Rental Entries -->
                    <div id="manual_entries" class="conditional-field" style="display: none;">
                        <h4 style="margin-bottom: 15px;">Manual Rental Schedule</h4>
                        <div id="rental_list">
                            <!-- Dynamically generated rental rows -->
                        </div>
                        <button type="button" onclick="addRentalRow()" style="margin-top: 10px; padding: 8px 16px; background: var(--color-brand-green); color: white; border: none; border-radius: 6px; cursor: pointer;">+ Add Rental</button>
                    </div>
                </div>

                <!-- Tab 4: Financial Details -->
                <div class="tab-content" id="tab3">
                    <div class="two-column">
                        <div class="form-group">
                            <label for="borrowing_rate">Borrowing Rate (%) <span class="mandatory">*</span></label>
                            <input type="number" id="borrowing_rate" name="Borrowing_rate" step="0.01" min="0" value="" required>
                        </div>
                        <div class="form-group">
                            <label for="currency">Currency</label>
                            <select id="currency" name="Currency">
                                <option value="">Select...</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="INR">INR</option>
                                <option value="GBP">GBP</option>
                            </select>
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="form-group">
                            <label for="fv_of_rou">Fair Value of ROU Asset</label>
                            <input type="number" id="fv_of_rou" name="FV_of_RoU" step="0.01" value="">
                        </div>
                        <div class="form-group">
                            <label for="compound_months">Compound Months</label>
                            <input type="number" id="compound_months" name="Compound_months" min="1" value="">
                        </div>
                    </div>

                    <!-- ARO Section -->
                    <div class="switch-toggle">
                        <label for="has_aro">Asset Retirement Obligation (ARO)</label>
                        <label class="switch">
                            <input type="checkbox" id="has_aro" onchange="toggleARO()">
                            <span class="slider"></span>
                        </label>
                        <span id="aro_label" style="font-weight: bold; margin-left: 10px; color: #6c757d;">No</span>
                    </div>

                    <div id="aro_fields" class="conditional-field" style="display: none;">
                        <h4 style="margin-bottom: 10px;">ARO (Asset Retirement Obligation) Details</h4>
                        <div class="two-column">
                            <div class="form-group">
                                <label for="aro_amount">ARO Initial Amount</label>
                                <input type="number" id="aro_amount" name="ARO" step="0.01" value="">
                            </div>
                            <div class="form-group">
                                <label for="aro_table">ARO Interest Table</label>
                                <input type="number" id="aro_table" name="ARO_table" step="0.01" value="">
                            </div>
                        </div>
                        <h5 style="margin-top: 15px; margin-bottom: 10px;">ARO Revisions (up to 8)</h5>
                        <div id="aro_revisions">
                            <!-- ARO revision fields will be added dynamically -->
                        </div>
                        <button type="button" onclick="addARORow()" style="margin-top: 10px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">+ Add ARO Revision</button>
                    </div>

                    <!-- Security Deposits -->
                    <div class="switch-toggle">
                        <label for="has_security">Security Deposits</label>
                        <label class="switch">
                            <input type="checkbox" id="has_security" onchange="toggleSecurity()">
                            <span class="slider"></span>
                        </label>
                        <span id="security_label" style="font-weight: bold; margin-left: 10px; color: #6c757d;">No</span>
                    </div>

                    <div id="security_fields" class="conditional-field" style="display: none;">
                        <h4 style="margin-bottom: 10px;">Security Deposit Details</h4>
                        <div class="two-column">
                            <div class="form-group">
                                <label for="security_deposit">Security Deposit Amount (Gross)</label>
                                <input type="number" id="security_deposit" name="Security_deposit" step="0.01" value="">
                            </div>
                            <div class="form-group">
                                <label for="security_discount">Security Discount Rate (%)</label>
                                <input type="number" id="security_discount" name="Security_discount" step="0.01" value="">
                            </div>
                        </div>
                        <h5 style="margin-top: 15px; margin-bottom: 10px;">Security Increases (up to 4)</h5>
                        <div id="security_increases">
                            <!-- Security increases will be added dynamically -->
                        </div>
                        <button type="button" onclick="addSecurityRow()" style="margin-top: 10px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">+ Add Security Increase</button>
                    </div>
                </div>

                <!-- Tab 5: Additional Details -->
                <div class="tab-content" id="tab4">
                        <div class="two-column">
                            <div class="form-group">
                                <label for="cost_center">Cost Center</label>
                                <input type="text" id="cost_center" name="Cost_centre" value="">
                            </div>
                            <div class="form-group">
                                <label for="profit_center">Profit Center</label>
                                <input type="text" id="profit_center" name="Profit_center" value="">
                            </div>
                        </div>

                    <!-- Lease Classifications -->
                    <div class="switch-toggle">
                        <label>Is Finance Lease (US GAAP)</label>
                        <select name="Finance_lease_USGAAP">
                            <option value="">Select...</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>

                    <div class="switch-toggle">
                        <label>Short Term Lease (IFRS/Ind AS)</label>
                        <select name="Shortterm_lease_IFRS_IndAS">
                            <option value="">Select...</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>

                    <!-- Transition Accounting -->
                    <div class="switch-toggle">
                        <label for="has_transition">Transition Accounting</label>
                        <label class="switch">
                            <input type="checkbox" id="has_transition" onchange="toggleTransition()">
                            <span class="slider"></span>
                        </label>
                        <span id="transition_label" style="font-weight: bold; margin-left: 10px; color: #6c757d;">No</span>
                    </div>

                    <div id="transition_fields" class="conditional-field" style="display: none;">
                        <div class="two-column">
                            <div class="form-group">
                                <label for="transition_date">Transition Date</label>
                                <input type="date" id="transition_date" name="Transition_date" value="">
                            </div>
                            <div class="form-group">
                                <label for="transition_option">Transition Option</label>
                                <select id="transition_option" name="Transition_option">
                                    <option value="">Select...</option>
                                    <option value="2A">Modified Retrospective</option>
                                    <option value="2B">Modified Retrospective (Simplified)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="initial_direct">Initial Direct Costs</label>
                            <input type="number" id="initial_direct" name="Initial_direct_expenditure" step="0.01" value="">
                        </div>
                        <div class="form-group">
                            <label for="lease_incentive">Lease Incentive</label>
                            <input type="number" id="lease_incentive" name="Lease_incentive" step="0.01" value="">
                        </div>
                    </div>

                    <!-- Impairments -->
                    <div class="switch-toggle">
                        <label for="has_impairment">Asset Impairments</label>
                        <label class="switch">
                            <input type="checkbox" id="has_impairment" onchange="toggleImpairments()">
                            <span class="slider"></span>
                        </label>
                        <span id="impairment_label" style="font-weight: bold; margin-left: 10px; color: #6c757d;">No</span>
                    </div>

                    <div id="impairment_fields" class="conditional-field" style="display: none;">
                        <h4 style="margin-bottom: 10px;">Impairment Details (up to 5)</h4>
                        <div id="impairment_list">
                            <div class="two-column" style="margin-bottom: 10px;">
                                <div class="form-group">
                                    <label for="impairment1">Impairment 1</label>
                                    <input type="number" id="impairment1" name="Impairment1" step="0.01" value="">
                                </div>
                                <div class="form-group">
                                    <label for="impairment_date1">Date</label>
                                    <input type="date" id="impairment_date1" name="Impairment_date_1" value="">
                                </div>
                            </div>
                        </div>
                        <button type="button" onclick="addImpairmentRow()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">+ Add Impairment</button>
                    </div>

                    <!-- Lease Classifications -->
                    <div class="two-column" style="margin-top: 20px;">
                        <div class="switch-toggle">
                            <label for="intragroup">Is Lease InterCompany (IntraGroup)?</label>
                            <select id="intragroup" name="IntraGroup_lease" style="width: auto; margin-left: 10px;">
                                <option value="">Select...</option>
                                <option value="Yes">Yes</option>
                                <option value="No">No</option>
                            </select>
                        </div>
                        <div class="switch-toggle">
                            <label for="sublease">Is Sublease?</label>
                            <select id="sublease" name="Sublease" style="width: auto; margin-left: 10px;">
                                <option value="">Select...</option>
                                <option value="Yes">Yes</option>
                                <option value="No">No</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" id="sublease_rou" style="display: none;">
                        <label for="sublease_rou_value">Starting RoU Value for Sublease</label>
                        <input type="number" id="sublease_rou_value" name="Sublease_RoU" step="0.01">
                    </div>

                    <!-- Modification Tracking -->
                    <h4 style="margin-top: 20px; margin-bottom: 10px;">Lease Modification Tracking</h4>
                    <div class="two-column">
                        <div class="form-group">
                            <label for="modifies_this_id">Modifies This Lease AutoID</label>
                            <input type="number" id="modifies_this_id" name="Modifies_this_ID" value="">
                        </div>
                        <div class="form-group">
                            <label for="modified_by_id">Modified By This Lease AutoID</label>
                            <input type="number" id="modified_by_id" name="Modified_by_this_ID" value="">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="date_modified">Date Modified</label>
                        <input type="date" id="date_modified" name="Date_modified" value="">
                    </div>
                    <div class="form-group">
                        <label for="head_lease_id">Head Lease ID</label>
                        <input type="number" id="head_lease_id" name="Head_Lease_ID" value="">
                    </div>

                    <!-- Additional Adjustments -->
                    <h4 style="margin-top: 20px; margin-bottom: 10px;">Additional Adjustments</h4>
                    <div class="two-column">
                        <div class="form-group">
                            <label for="scope_reduction">Lease Scope Reduction (%)</label>
                            <input type="number" id="scope_reduction" name="Scope_reduction" step="0.01" value="">
                        </div>
                        <div class="form-group">
                            <label for="scope_date">Scope Reduction Date</label>
                            <input type="date" id="scope_date" name="Scope_date" value="">
                        </div>
                    </div>

                    <!-- COVID Practical Expedient -->
                    <div class="switch-toggle" style="margin-top: 15px;">
                        <label for="practical_expedient">COVID 19 Practical Expedient</label>
                        <select id="practical_expedient" name="Practical_expedient" style="width: auto; margin-left: 10px;">
                            <option value="">Select...</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>

                    <!-- Audit Trail -->
                    <h4 style="margin-top: 20px; margin-bottom: 10px;">Audit Trail</h4>
                    <div class="two-column">
                        <div class="form-group">
                            <label for="entered_by">Entered By</label>
                            <input type="text" id="entered_by" name="Entered_by" value="">
                        </div>
                        <div class="form-group">
                            <label for="last_modified_by">Last Modified By</label>
                            <input type="text" id="last_modified_by" name="Last_modified_by" value="">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="last_reviewed_by">Last Reviewed By</label>
                        <input type="text" id="last_reviewed_by" name="Last_reviewed_by" value="">
                    </div>
                    <div class="form-group" id="sublease_rou" style="display: none;">
                        <label for="sublease_rou_value">Starting RoU Value for Sublease</label>
                        <input type="number" id="sublease_rou_value" name="Sublease_RoU" step="0.01" value="">
                    </div>
                </div>

                <!-- Tab 6: Documents -->
                <div class="tab-content" id="tab5">
                    <h3 style="margin-bottom: 20px;">üìÑ Lease Documents</h3>
                    <p style="margin-bottom: 20px; color: #6c757d;">Upload and manage lease contract documents (PDF, Word, Excel, etc.)</p>
                    
                    <!-- Upload Section -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px;">Upload New Document</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
                            <input type="file" id="documentFileInput" style="flex: 1; min-width: 200px; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px;" />
                            <select id="documentTypeSelect" style="padding: 10px; border: 2px solid #dee2e6; border-radius: 6px;">
                                <option value="contract">Contract</option>
                                <option value="amendment">Amendment</option>
                                <option value="addendum">Addendum</option>
                                <option value="termination">Termination Notice</option>
                                <option value="other">Other</option>
                            </select>
                            <button type="button" onclick="uploadDocument()" style="padding: 10px 20px; background: var(--color-brand-green); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">üì§ Upload</button>
                        </div>
                        <div id="uploadStatus" style="margin-top: 10px; font-size: 0.9rem;"></div>
                    </div>

                    <!-- Documents List -->
                    <div id="documentsList" style="background: white; border: 1px solid #dee2e6; border-radius: 10px; overflow: hidden;">
                        <div style="padding: 20px; text-align: center; color: #6c757d;">
                            <p>Loading documents...</p>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn-primary" onclick="saveLease()">üíæ Save as Draft</button>
                <div id="statusIndicator" style="display: none; margin-top: 15px; padding: 12px 20px; border-radius: 8px; background: var(--color-sage-1); border: 1px solid var(--color-border-sage);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5rem;">üìã</span>
                        <div>
                            <strong style="color: var(--color-text-primary);">Draft Saved</strong>
                            <div style="font-size: 0.9rem; color: var(--color-text-secondary); margin-top: 2px;">Ready to submit for approval</div>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-primary" onclick="window.showSubmitApprovalModal && window.showSubmitApprovalModal()" id="submitApprovalBtn" style="margin-top: 15px; background: var(--color-brand-green); display: none;">‚úÖ Submit for Approval</button>
            </form>

            <div class="results" id="results">
                <!-- Results will be displayed here -->
            </div>
        </div>
    </div>
    
    <!-- Submit for Approval Modal -->
    <div id="submitApprovalModal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(68,66,90,0.3);">
      <div style="background: white; width: 450px; margin: 120px auto 0 auto; border-radius: 15px; box-shadow: 0 4px 30px rgba(0,0,0,0.19); padding: 24px 28px 22px 28px; position: relative;">
        <div style="font-size: 1.15rem; font-weight: bold; color: #444; margin-bottom: 12px;">‚úÖ Submit for Approval</div>
        <label style="font-size: 0.95rem; margin-bottom: 6px; color: #555;">Request Type</label>
        <select id="approvalRequestType" style="width: 100%; padding: 10px; border: 1.5px solid #ddd; border-radius: 6px; font-size: 0.97rem; margin-bottom: 16px;">
            <option value="creation">New Lease Creation</option>
            <option value="edit">Lease Edit</option>
            <option value="deletion">Lease Deletion</option>
        </select>
        <label style="font-size: 0.95rem; margin-bottom: 6px; color: #555;">Comments (Optional)</label>
        <textarea id="approvalComments" style="width: 100%; padding: 10px; border: 1.5px solid #ddd; border-radius: 6px; font-size: 0.97rem; margin-bottom: 16px; min-height: 80px; resize: vertical;"></textarea>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
          <button onclick="window.submitForApproval && window.submitForApproval()" style="background: #22c55e; color: white; border: none; border-radius: 6px; padding: 10px 18px; font-weight: bold;">Submit</button>
          <button onclick="window.hideSubmitApprovalModal && window.hideSubmitApprovalModal()" style="background: #ef4444; color: white; border: none; border-radius: 6px; padding: 10px 16px;">Cancel</button>
        </div>
      </div>
    </div>
    
    <!-- Email Modal (static, always available) -->
    <div id="emailModal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(68,66,90,0.3);">
      <div style="background: white; width: 350px; margin: 120px auto 0 auto; border-radius: 15px; box-shadow: 0 4px 30px rgba(0,0,0,0.19); padding: 24px 28px 22px 28px; position: relative;">
        <div style="font-size: 1.15rem; font-weight: bold; color: #444; margin-bottom: 12px;">üìß Email Lease Report</div>
        <label style="font-size: 0.95rem; margin-bottom: 6px; color: #555;">Recipient Email</label>
        <input type="email" id="recipientEmail" required style="width: 100%; padding: 10px; border: 1.5px solid #ddd; border-radius: 6px; font-size: 0.97rem; margin-bottom: 16px; color: #222;">
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
          <button onclick="window.sendReportEmail && window.sendReportEmail()" style="background: #22c55e; color: white; border: none; border-radius: 6px; padding: 10px 18px; font-weight: bold;">Send</button>
          <button onclick="window.hideEmailModal && window.hideEmailModal()" style="background: #ef4444; color: white; border: none; border-radius: 6px; padding: 10px 16px;">Cancel</button>
        </div>
      </div>
    </div>

    <script>
        // ============ PROGRESS BAR INITIALIZATION ============
        NProgress.configure({ 
            showSpinner: true,
            trickleRate: 0.02,
            trickleSpeed: 200
        });
        
        // ============ NOTIFICATION SYSTEM ============
        function showNotification(type, title, message, duration = 5000) {
            const container = document.getElementById('notificationContainer');
            if (!container) return;
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            notification.innerHTML = `
                <div class="notification-icon">${icons[type] || '‚ÑπÔ∏è'}</div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="closeNotification(this)">&times;</button>
            `;
            
            container.appendChild(notification);
            
            // Trigger animation
            setTimeout(() => notification.classList.add('show'), 10);
            
            // Auto-remove after duration
            if (duration > 0) {
                setTimeout(() => closeNotification(notification.querySelector('.notification-close')), duration);
            }
            
            return notification;
        }
        
        function closeNotification(closeBtn) {
            const notification = closeBtn.parentElement;
            if (!notification) return;
            
            notification.classList.add('hide');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }
        
        // ============ END NOTIFICATION SYSTEM ============
        
        // NO AUTH CHECK - PAGE LOADS IMMEDIATELY
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('Page loaded - NO auth check');
            // Try to get user info silently
            try {
                const response = await fetch('http://localhost:5001/api/user', {
                    credentials: 'include'
                });
                const data = await response.json();
                if (data.success && data.user) {
                    console.log('‚úì Got user:', data.user.username);
                    const usernameEl = document.getElementById('username');
                    if (usernameEl) usernameEl.textContent = data.user.username;
                    
                    // Check if user is admin or reviewer
                    isAdminOrReviewer = data.user.role === 'admin' || data.user.role === 'reviewer';
                    
                    // Hide submit button and indicator for admin/reviewer
                    if (isAdminOrReviewer) {
                        document.getElementById('statusIndicator').style.display = 'none';
                        document.getElementById('submitApprovalBtn').style.display = 'none';
                    }
                } else {
                    console.log('‚Ñπ No session');
                    const usernameEl = document.getElementById('username');
                    if (usernameEl) usernameEl.textContent = 'Guest';
                }
            } catch (e) {
                console.log('‚ö† Could not get user info');
                const usernameEl = document.getElementById('username');
                if (usernameEl) usernameEl.textContent = 'Guest';
            }
            
            // Check if editing (have lease_id in URL)
            const urlParams = new URLSearchParams(window.location.search);
            const leaseId = urlParams.get('id') || urlParams.get('lease_id');
            if (leaseId) {
                console.log(`üìù Loading lease ${leaseId} for editing...`);
                await loadLeaseForEdit(leaseId);
            }
        });
        
        async function loadLeaseForEdit(leaseId) {
            try {
                const response = await fetch(`http://localhost:5001/api/leases/${leaseId}`, {
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success && result.lease) {
                    const lease = result.lease;
                    console.log('üìã Lease loaded:', lease);
                    
                    // Map backend field names to form field IDs
                    const fieldMap = {
                        'asset_class': 'asset_class',
                        'asset_id_code': 'asset_id',
                        'lease_name': 'asset_name',
                        'description': 'description',
                        'counterparty': 'counterparty',
                        'lease_start_date': 'lease_start',
                        'first_payment_date': 'first_payment',
                        'end_date': 'end_date',
                        'agreement_date': 'agreement_date',
                        'termination_date': 'termination_date',
                        'tenure': 'tenure',
                        'frequency_months': 'frequency',
                        'day_of_month': 'day_of_month',
                        'accrual_day': 'accrual_day',
                        'auto_rentals': 'auto_rentals',
                        'rental_1': 'Rental_1',
                        'rental_2': 'Rental_2',
                        'escalation_percent': 'Escalation_percent',
                        'esc_freq_months': 'esc_freq',
                        'escalation_start_date': 'escalation_start',
                        'borrowing_rate': 'borrowing_rate',
                        'compound_months': 'compound_months',
                        'currency': 'currency',
                        'fv_of_rou': 'fv_of_rou',
                        'initial_direct_expenditure': 'initial_direct',
                        'lease_incentive': 'lease_incentive',
                        'aro': 'aro_amount',
                        'aro_table': 'aro_table',
                        'security_deposit': 'security_deposit',
                        'security_discount': 'security_discount',
                        'cost_centre': 'cost_center',
                        'region': 'region',
                        'segment': 'segment',
                        'group_entity_name': 'entity_name',
                        'profit_center': 'profit_center',
                        'finance_lease_usgaap': 'Finance_lease_USGAAP',
                        'shortterm_lease_ifrs_indas': 'Shortterm_lease_IFRS_IndAS',
                        'sublease': 'sublease',
                        'sublease_rou': 'sublease_rou_value',
                        'manual_adj': 'manual_adj'
                    };
                    
                    // Populate all form fields
                    for (const [dbKey, formId] of Object.entries(fieldMap)) {
                        const value = lease[dbKey];
                        if (value !== null && value !== undefined && value !== '') {
                            const element = document.getElementById(formId) || document.querySelector(`[name="${formId}"]`);
                            if (element) {
                                if (element.type === 'checkbox') {
                                    element.checked = value === 'Yes' || value === true || value === 1;
                                } else {
                                    element.value = value;
                                }
                                
                                // Also update hidden fields
                                if (dbKey === 'escalation_start_date') {
                                    const hiddenField = document.getElementById('escalation_start_date');
                                    if (hiddenField) hiddenField.value = value;
                                }
                                if (dbKey === 'esc_freq_months') {
                                    const hiddenField = document.getElementById('esc_freq_months');
                                    if (hiddenField) hiddenField.value = value;
                                }
                            }
                        }
                    }
                    
                    // Handle escalation toggle if escalation_start_date exists
                    if (lease.escalation_start_date) {
                        const escalationCheckbox = document.getElementById('escalation');
                        if (escalationCheckbox) {
                            escalationCheckbox.checked = true;
                            toggleEscalation();
                        }
                    }
                    
                    console.log('‚úÖ Lease data populated in form');
                    
                    // Show status indicator and submit button if draft (only for regular users)
                    if (!isAdminOrReviewer) {
                        const approvalStatus = lease.approval_status || 'draft';
                        const indicator = document.getElementById('statusIndicator');
                        const indicatorIcon = indicator.querySelector('span');
                        const indicatorTitle = indicator.querySelector('strong');
                        const indicatorDesc = indicator.querySelector('div > div');
                        
                        if (approvalStatus === 'draft') {
                            indicator.style.display = 'block';
                            indicator.style.background = 'var(--color-sage-1)';
                            indicatorIcon.textContent = 'üìã';
                            indicatorTitle.textContent = 'Draft Saved';
                            indicatorDesc.textContent = 'Ready to submit for approval';
                            document.getElementById('submitApprovalBtn').style.display = 'inline-block';
                        } else if (approvalStatus === 'pending') {
                            indicator.style.display = 'block';
                            indicator.style.background = '#fff4e6';
                            indicatorIcon.textContent = '‚è≥';
                            indicatorTitle.textContent = 'Pending Approval';
                            indicatorDesc.textContent = 'Waiting for reviewer approval';
                            document.getElementById('submitApprovalBtn').style.display = 'none';
                        } else if (approvalStatus === 'approved') {
                            indicator.style.display = 'block';
                            indicator.style.background = '#d4f5e0';
                            indicatorIcon.textContent = '‚úÖ';
                            indicatorTitle.textContent = 'Approved';
                            indicatorDesc.textContent = 'This lease is approved and active';
                            document.getElementById('submitApprovalBtn').style.display = 'none';
                        }
                    }
                } else {
                    console.error('‚ùå Failed to load lease:', result);
                }
            } catch (error) {
                console.error('‚ùå Error loading lease:', error);
            }
        }
        
        async function logout() {
            try {
                await fetch('http://localhost:5001/api/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = 'login.html';
            } catch (error) {
                window.location.href = 'login.html';
            }
        }

        let currentTab = 0;
        let rentalCount = 1;
        let aroRevCount = 0;
        let securityCount = 0;

        // Populate day of month dropdown
        for (let i = 1; i <= 31; i++) {
            let option = document.createElement('option');
            option.value = i;
            option.text = i;
            document.getElementById('day_of_month').appendChild(option);
        }


        function showTab(index) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab')[index].classList.add('active');
            document.getElementById(`tab${index}`).classList.add('active');
            currentTab = index;
        }

        function toggleAutoRentals() {
            const checked = document.getElementById('auto_rentals').checked;
            document.getElementById('auto_label').textContent = checked ? 'Yes' : 'No';
            document.getElementById('auto_label').style.color = checked ? '#28a745' : '#6c757d';
            document.getElementById('auto_rental_field').style.display = checked ? 'block' : 'none';
        }

        function toggleEscalation() {
            const checked = document.getElementById('escalation').checked;
            document.getElementById('escalation_label').textContent = checked ? 'Yes' : 'No';
            document.getElementById('escalation_label').style.color = checked ? '#28a745' : '#6c757d';
            document.getElementById('escalation_fields').style.display = checked ? 'block' : 'none';
        }

        function toggleManualAdj() {
            const checked = document.getElementById('manual_adj').checked;
            document.getElementById('manual_label').textContent = checked ? 'Yes' : 'No';
            document.getElementById('manual_label').style.color = checked ? '#28a745' : '#6c757d';
            document.getElementById('manual_entries').style.display = checked ? 'block' : 'none';
        }

        function toggleARO() {
            const checked = document.getElementById('has_aro').checked;
            document.getElementById('aro_label').textContent = checked ? 'Yes' : 'No';
            document.getElementById('aro_label').style.color = checked ? '#28a745' : '#6c757d';
            document.getElementById('aro_fields').style.display = checked ? 'block' : 'none';
        }

        function toggleSecurity() {
            const checked = document.getElementById('has_security').checked;
            document.getElementById('security_label').textContent = checked ? 'Yes' : 'No';
            document.getElementById('security_label').style.color = checked ? '#28a745' : '#6c757d';
            document.getElementById('security_fields').style.display = checked ? 'block' : 'none';
        }

        function toggleTransition() {
            const checked = document.getElementById('has_transition').checked;
            document.getElementById('transition_label').textContent = checked ? 'Yes' : 'No';
            document.getElementById('transition_label').style.color = checked ? '#28a745' : '#6c757d';
            document.getElementById('transition_fields').style.display = checked ? 'block' : 'none';
        }

        function toggleImpairments() {
            const checked = document.getElementById('has_impairment').checked;
            document.getElementById('impairment_label').textContent = checked ? 'Yes' : 'No';
            document.getElementById('impairment_label').style.color = checked ? '#28a745' : '#6c757d';
            document.getElementById('impairment_fields').style.display = checked ? 'block' : 'none';
        }

        let impairmentCount = 1;

        function addRentalRow() {
            const list = document.getElementById('rental_list');
            const div = document.createElement('div');
            div.className = 'rental-row';
            div.innerHTML = `
                <input type="number" name="Rental_${rentalCount + 1}" placeholder="Rental Amount" step="0.01">
                <input type="date" name="Rental_date_${rentalCount + 1}">
                <button type="button" onclick="this.parentElement.remove()">Remove</button>
            `;
            list.appendChild(div);
            rentalCount++;
        }

        function addARORow() {
            if (aroRevCount >= 8) {
                alert('Maximum 8 ARO revisions allowed');
                return;
            }
            aroRevCount++;
            const list = document.getElementById('aro_revisions');
            const div = document.createElement('div');
            div.className = 'two-column';
            div.innerHTML = `
                <div class="form-group">
                    <label>ARO Revision ${aroRevCount} Amount</label>
                    <input type="number" name="ARO_Revision_${aroRevCount}" step="0.01">
                </div>
                <div class="form-group">
                    <label>ARO Revision ${aroRevCount} Date</label>
                    <input type="date" name="ARO_date_${aroRevCount}">
                </div>
                <button type="button" onclick="this.parentElement.remove(); aroRevCount--;" style="margin-top: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove</button>
            `;
            list.appendChild(div);
        }

        function addSecurityRow() {
            if (securityCount >= 4) {
                alert('Maximum 4 security increases allowed');
                return;
            }
            securityCount++;
            const list = document.getElementById('security_increases');
            const div = document.createElement('div');
            div.className = 'two-column';
            div.innerHTML = `
                <div class="form-group">
                    <label>Security Increase ${securityCount} Amount</label>
                    <input type="number" name="Increase_security_${securityCount}" step="0.01">
                </div>
                <div class="form-group">
                    <label>Security Increase ${securityCount} Date</label>
                    <input type="date" name="Security_date_${securityCount}">
                </div>
                <button type="button" onclick="this.parentElement.remove(); securityCount--;" style="margin-top: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove</button>
            `;
            list.appendChild(div);
        }

        function addImpairmentRow() {
            if (impairmentCount >= 5) {
                alert('Maximum 5 impairments allowed');
                return;
            }
            impairmentCount++;
            const list = document.getElementById('impairment_list');
            const div = document.createElement('div');
            div.className = 'two-column';
            div.innerHTML = `
                <div class="form-group">
                    <label>Impairment ${impairmentCount} Amount</label>
                    <input type="number" name="Impairment${impairmentCount}" step="0.01">
                </div>
                <div class="form-group">
                    <label>Impairment ${impairmentCount} Date</label>
                    <input type="date" name="Impairment_date_${impairmentCount}">
                </div>
                <button type="button" onclick="this.parentElement.remove(); impairmentCount--;" style="margin-top: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove</button>
            `;
            list.appendChild(div);
        }

        document.getElementById('leaseForm').addEventListener('submit', (e) => {
            e.preventDefault();
            calculateLease();
        });

        async function extractFromPdf() {
            const fileInput = document.getElementById('pdfFileInput');
            const statusDiv = document.getElementById('extractionStatus');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showNotification('error', 'No File Selected', 'Please select a PDF file first.');
                return;
            }
            
            const file = fileInput.files[0];
            const apiKey = document.getElementById('apiKeyInput').value;
            
            // Show progress bar and notification
            NProgress.start();
            statusDiv.innerHTML = '';
            const progressNotif = showNotification('info', 'AI Processing', 'üìÑ Uploading PDF and analyzing with Google Gemini AI...', 0);
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                if (apiKey) {
                    formData.append('api_key', apiKey);
                }
                
                const response = await fetch('http://localhost:5001/api/extract_lease_pdf', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    NProgress.done();
                    
                    // Remove progress notification
                    if (progressNotif) {
                        closeNotification(progressNotif.querySelector('.notification-close'));
                    }
                    
                    // Auto-fill form with extracted data
                    const data = result.data;
                    
                    // Map extracted fields to form fields
                    if (data.description) {
                        const elem = document.getElementById('description');
                        if (elem) elem.value = data.description;
                    }
                    if (data.asset_class) {
                        const elem = document.getElementById('asset_class');
                        if (elem) elem.value = data.asset_class;
                    }
                    if (data.asset_id_code) {
                        const elem = document.getElementById('asset_id');
                        if (elem) elem.value = data.asset_id_code;
                    }
                    if (data.lease_start_date) {
                        const startDate = document.getElementById('lease_start');
                        if (startDate) startDate.value = data.lease_start_date;
                    }
                    if (data.end_date) {
                        const endDate = document.getElementById('end_date');
                        if (endDate) endDate.value = data.end_date;
                    }
                    if (data.first_payment_date) {
                        const firstPayment = document.getElementById('first_payment');
                        if (firstPayment) firstPayment.value = data.first_payment_date;
                    }
                    if (data.tenure) {
                        const elem = document.getElementById('tenure');
                        if (elem) elem.value = data.tenure;
                    }
                    if (data.frequency_months) {
                        const elem = document.getElementById('frequency');
                        if (elem) elem.value = data.frequency_months;
                    }
                    if (data.day_of_month) {
                        const elem = document.getElementById('day_of_month');
                        if (elem) elem.value = data.day_of_month;
                    }
                    if (data.rental_1) {
                        const rentalElem = document.getElementById('rental_amount');
                        if (rentalElem) rentalElem.value = data.rental_1;
                        // Auto-enable auto_rentals if rental found
                        const autoRentalsCheckbox = document.getElementById('auto_rentals');
                        if (autoRentalsCheckbox) autoRentalsCheckbox.checked = true;
                        toggleAutoRentals();
                    }
                    if (data.currency) {
                        const elem = document.getElementById('currency');
                        if (elem) elem.value = data.currency;
                    }
                    if (data.borrowing_rate) {
                        const elem = document.getElementById('borrowing_rate');
                        if (elem) elem.value = data.borrowing_rate;
                    }
                    if (data.security_deposit) {
                        const elem = document.getElementById('security_deposit');
                        if (elem) elem.value = data.security_deposit;
                    }
                    if (data.esc_freq_months) {
                        const elem = document.getElementById('esc_freq_months');
                        if (elem) elem.value = data.esc_freq_months;
                    }
                    if (data.escalation_percent) {
                        const elem = document.getElementById('escalation_percent');
                        if (elem) elem.value = data.escalation_percent;
                    }
                    if (data.escalation_start_date) {
                        const escStart = document.getElementById('escalation_start');
                        if (escStart) escStart.value = data.escalation_start_date;
                    }
                    if (data.lease_incentive) {
                        const elem = document.getElementById('lease_incentive');
                        if (elem) elem.value = data.lease_incentive;
                    }
                    if (data.initial_direct_expenditure) {
                        const elem = document.getElementById('initial_direct_expenditure');
                        if (elem) elem.value = data.initial_direct_expenditure;
                    }
                    
                    statusDiv.innerHTML = `<span style="color: #28a745;">‚úÖ Successfully extracted and filled ${Object.keys(data).length} fields!</span>`;
                    
                    // Show success notification
                    showNotification('success', 'AI Extraction Successful', `Extracted ${Object.keys(data).length} fields. Please review and adjust if needed.`, 8000);
                    
                    // Small success message in extraction status
                    statusDiv.innerHTML = `<span style="color: #28a745;">‚úÖ Extracted ${Object.keys(data).length} fields successfully!</span>`;
                } else {
                    NProgress.done();
                    
                    // Remove progress notification
                    if (progressNotif) {
                        closeNotification(progressNotif.querySelector('.notification-close'));
                    }
                    
                    statusDiv.innerHTML = '';
                    showNotification('error', 'Extraction Failed', result.error || 'Failed to extract data from PDF.');
                }
            } catch (error) {
                NProgress.done();
                console.error('Extraction error:', error);
                
                // Remove progress notification
                if (progressNotif) {
                    closeNotification(progressNotif.querySelector('.notification-close'));
                }
                
                statusDiv.innerHTML = '';
                showNotification('error', 'Extraction Error', error.message);
            }
        }

        async function saveLease() {
            const formData = new FormData(document.getElementById('leaseForm'));
            const data = Object.fromEntries(formData);
            
            // Validate required fields
            const requiredFields = {
                'asset_name': 'Asset Name',
                'asset_class': 'Asset Class',
                'lease_start': 'Lease Start Date',
                'first_payment': 'First Payment Date',
                'end_date': 'Lease End Date',
                'frequency': 'Rental Frequency',
                'day_of_month': 'Day of Month',
                'accrual_day': 'Rent Accrual Day',
                'borrowing_rate': 'Borrowing Rate'
            };
            
            const missingFields = [];
            let firstMissingFieldId = null;
            
            for (const [field, label] of Object.entries(requiredFields)) {
                const value = data[field] || document.getElementById(field)?.value;
                if (!value || value.trim() === '' || value === 'Select...') {
                    missingFields.push(label);
                    if (!firstMissingFieldId) {
                        firstMissingFieldId = field;
                    }
                }
            }
            
            // Also check if rental amount is needed (when auto_rentals is enabled)
            const autoRentals = document.getElementById('auto_rentals')?.checked;
            if (autoRentals) {
                const rentalAmount = data['rental_amount'] || document.getElementById('rental_amount')?.value;
                if (!rentalAmount || rentalAmount.trim() === '') {
                    missingFields.push('Rental Amount');
                    if (!firstMissingFieldId) {
                        firstMissingFieldId = 'rental_amount';
                    }
                }
            }
            
            if (missingFields.length > 0) {
                showNotification('error', 'Required Fields Missing', 
                    'Please fill in: ' + missingFields.join(', ') + '. Required fields are marked with *', 8000);
                
                // Scroll to first missing field
                if (firstMissingFieldId) {
                    const element = document.getElementById(firstMissingFieldId);
                    if (element) {
                        // Switch to the appropriate tab if needed
                        if (firstMissingFieldId.includes('asset')) {
                            showTab(0); // General tab
                        } else if (firstMissingFieldId.includes('lease_start') || firstMissingFieldId.includes('payment') || 
                                   firstMissingFieldId.includes('end_date') || firstMissingFieldId.includes('frequency') ||
                                   firstMissingFieldId.includes('day') || firstMissingFieldId.includes('accrual')) {
                            showTab(1); // Dates & Terms tab
                        } else if (firstMissingFieldId.includes('rental') || firstMissingFieldId.includes('Escalation')) {
                            showTab(2); // Rentals tab
                        } else if (firstMissingFieldId.includes('borrowing') || firstMissingFieldId.includes('currency')) {
                            showTab(3); // Financial tab
                        }
                        
                        // Scroll to element
                        setTimeout(() => {
                            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            element.focus();
                            
                            // Highlight the field
                            element.style.border = '2px solid #dc3545';
                            element.style.boxShadow = '0 0 0 3px rgba(220, 53, 69, 0.25)';
                            setTimeout(() => {
                                element.style.border = '';
                                element.style.boxShadow = '';
                            }, 3000);
                        }, 300);
                    }
                }
                return;
            }
            
            // Just save as draft - no calculation needed
            try {
                // Try to call Python backend first
                // Map form field names to backend expected names
                const mappedData = {};
                
                // Field name mappings: form field name -> backend field name
                const fieldMappings = {
                    'Escalation_Start': 'escalation_start_date',
                    'escalation_start_date': 'escalation_start_date',
                    'Esc_Freq_months': 'esc_freq_months',
                    'esc_freq_months': 'esc_freq_months',
                    'Asset_Name': 'lease_name',  // Asset name maps to lease_name in DB
                    'Rental_1': 'rental_1',
                    'Rental_2': 'rental_2',
                    'lease_start': 'lease_start_date',
                    'first_payment': 'first_payment_date',
                    'end_date': 'end_date',
                    'day_of_month': 'day_of_month',
                    'frequency': 'frequency_months',
                    'Escalation_percent': 'escalation_percent',
                    'Borrowing_rate': 'borrowing_rate',
                    'initial_direct_costs': 'initial_direct_expenditure',
                    'initial_direct_expenditure': 'initial_direct_expenditure',
                    'Security_deposit': 'security_deposit',
                    'ARO': 'aro',
                    'aro_initial': 'aro',
                    'Lease_incentive': 'lease_incentive',
                    'Finance_lease': 'finance_lease_usgaap',
                    'Short_term_ifrs': 'shortterm_lease_ifrs_indas',
                    'Is_sublease': 'sublease'
                };
                
                // Process all form fields
                for (const [key, value] of Object.entries(data)) {
                    let backendKey = fieldMappings[key] || key.replace(/-/g, '_').toLowerCase();
                    
                    // Always set the value, even if it's empty (for updates to clear fields)
                    // But skip if it's a duplicate mapping
                    if (fieldMappings[key] && mappedData[backendKey] === undefined) {
                        mappedData[backendKey] = value || '';
                    } else if (!fieldMappings[key] && !mappedData[backendKey]) {
                        mappedData[backendKey] = value || '';
                    }
                }
                
                // Ensure escalation fields are always set (even if empty)
                if (mappedData['escalation_start_date'] === undefined) {
                    mappedData['escalation_start_date'] = data['Escalation_Start'] || data['escalation_start_date'] || '';
                }
                if (mappedData['esc_freq_months'] === undefined) {
                    mappedData['esc_freq_months'] = data['Esc_Freq_months'] || data['esc_freq_months'] || '';
                }
                
                console.log('Sending data:', data);
                
                // Save to database
                console.log('Saving lease data:', data);
                
                // Check if we're editing (have lease_id in URL)
                const urlParams = new URLSearchParams(window.location.search);
                const leaseId = urlParams.get('id') || urlParams.get('lease_id');
                const isEdit = !!leaseId;
                
                const url = isEdit 
                    ? `http://localhost:5001/api/leases/${leaseId}`
                    : 'http://localhost:5001/api/leases';
                
                const method = isEdit ? 'PUT' : 'POST';
                
                console.log('üì§ Sending to backend:', mappedData);
                
                const response = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(mappedData),
                    credentials: 'include'
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Lease saved:', result);
                    
                    if (result.success) {
                        // Set currentLeaseId before redirecting (for document tracking)
                        if (result.lease_id) {
                            currentLeaseId = result.lease_id;
                        }
                        showNotification('success', 'Draft Saved', 'Lease ID: ' + result.lease_id + ' saved as draft.', 3000);
                        
                        // Show status indicator and submit button (only for regular users)
                        if (!isAdminOrReviewer) {
                            document.getElementById('statusIndicator').style.display = 'block';
                            document.getElementById('submitApprovalBtn').style.display = 'inline-block';
                            
                            // Scroll to show the buttons
                            document.getElementById('statusIndicator').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    } else {
                        showNotification('error', 'Save Failed', result.error || 'Failed to save lease.');
                    }
                    return;
                } else {
                    const errorText = await response.text();
                    console.error('Backend returned error:', errorText);
                    throw new Error(`Backend returned ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('Error calling backend:', error);
                const resultsDiv = document.getElementById('results');
                if (!resultsDiv) {
                    console.error('Results div not found!');
                    alert('Error: Results div not found in HTML');
                    return;
                }
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h3 style="color: #dc3545;">‚ùå Backend Error</h3>
                        <p>Error: ${error.message}</p>
                        <p>Please check browser console (F12) for details</p>
                        <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: left; display: inline-block;">
Backend should be running at: http://localhost:5001
Check terminal or restart with: ./start_app.sh
                        </pre>
                    </div>
                `;
            document.getElementById('results').classList.add('show');
                return;
            }
            
            // This should never execute - Python backend must be running
            console.error('Python backend failed but no error thrown');
        }
        
        // Kept for reference but not called anymore
        function getOldResults() {
            const results = {
                asset_name: data['Asset_Name'] || 'N/A',
                asset_class: data['Asset_class'] || 'N/A',
                description: data['Description'] || '',
                lease_start: leaseStart,
                lease_end: leaseEnd,
                total_payments: totalPayments,
                rental_amount: rental,
                frequency: frequency === 1 ? 'Monthly' : frequency === 3 ? 'Quarterly' : frequency === 12 ? 'Annual' : 'Custom',
                monthly_payment: rental,
                total_rental_payments: totalRentalPayments.toFixed(2),
                borrowing_rate: borrowingRate.toFixed(2),
                lease_liability: leaseLiability.toFixed(2),
                rou_asset: rouAsset.toFixed(2),
                depreciation_expense: depreciation.toFixed(2),
                interest_expense: totalInterest.toFixed(2),
                aro_amount: aroAmount.toFixed(2),
                aro_interest: aroInterest.toFixed(2),
                security_deposit: securityDeposit.toFixed(2),
                security_interest: securityInterest.toFixed(2),
                initial_direct_costs: initialDirect.toFixed(2),
                lease_incentive: leaseIncentive.toFixed(2),
                net_rou_asset: (rouAsset - (depreciation * tenure)).toFixed(2),
                total_cost: (rouAsset + totalInterest + aroInterest).toFixed(2)
            };
            
            // Display detailed results matching Excel format
            const resultsDiv2 = document.getElementById('results');
            if (!resultsDiv2) {
                console.error('Results div not found at line 924');
                return;
            }
            resultsDiv2.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                    <h2 style="color: var(--color-text-primary); margin-bottom: 20px; text-align: center;">üìä Lease Calculation Results</h2>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #333; margin-bottom: 15px;">Asset Information</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div><strong>Asset Name:</strong> ${results.asset_name}</div>
                            <div><strong>Asset Class:</strong> ${results.asset_class}</div>
                            <div><strong>Description:</strong> ${results.description || 'N/A'}</div>
                            <div><strong>Lease Term:</strong> ${tenure} months (${(tenure/12).toFixed(1)} years)</div>
                        </div>
                    </div>

                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #333; margin-bottom: 15px;">Payment Details</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div><strong>Payment Amount:</strong> $${results.monthly_payment.toFixed(2)}</div>
                            <div><strong>Payment Frequency:</strong> ${results.frequency}</div>
                            <div><strong>Total Payments:</strong> ${results.total_payments}</div>
                            <div><strong>Total Rental Payments:</strong> $${results.total_rental_payments}</div>
                        </div>
                    </div>

                    <div style="background: var(--color-sage-1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: var(--color-text-primary); margin-bottom: 15px;">üìà Balance Sheet Items</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div><strong>Lease Liability (Initial):</strong> $${results.lease_liability}</div>
                            <div><strong>ROU Asset (Initial):</strong> $${results.rou_asset}</div>
                            <div><strong>Net ROU Asset:</strong> $${results.net_rou_asset}</div>
                            <div><strong>Security Deposit:</strong> $${results.security_deposit}</div>
                        </div>
                    </div>

                    <div style="background: var(--color-sage-1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: var(--color-text-primary); margin-bottom: 15px;">üí∞ P&L Items</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div><strong>Depreciation Expense:</strong> $${results.depreciation_expense}/month</div>
                            <div><strong>Interest Expense:</strong> $${results.interest_expense} (total)</div>
                            <div><strong>Total Lease Cost:</strong> $${results.total_cost}</div>
                            <div><strong>Borrowing Rate:</strong> ${results.borrowing_rate}%</div>
                        </div>
                    </div>

                    <div style="background: var(--color-sage-1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: var(--color-text-primary); margin-bottom: 15px;">üîÑ ARO (Asset Retirement Obligation)</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div><strong>ARO Amount:</strong> $${results.aro_amount}</div>
                            <div><strong>ARO Interest:</strong> $${results.aro_interest}</div>
                        </div>
                    </div>

                    <div style="background: var(--color-sage-1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: var(--color-text-primary); margin-bottom: 15px;">üè¶ Additional Items</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div><strong>Initial Direct Costs:</strong> $${results.initial_direct_costs}</div>
                            <div><strong>Lease Incentive:</strong> $${results.lease_incentive}</div>
                            <div><strong>Security Interest:</strong> $${results.security_interest}</div>
                            <div><strong>Date Range:</strong> ${leaseStart} to ${leaseEnd}</div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <p style="color: #28a745; font-weight: bold;">‚úÖ All fields captured and calculated successfully!</p>
                        <p style="color: #6c757d; font-size: 0.9rem;">Ready for journal entries and financial reporting</p>
                    </div>

                    <!-- Lease Amortization Schedule - All 13 Columns from Excel -->
                    <div style="margin-top: 30px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: var(--color-text-primary); margin: 0;">üìä Complete Lease Amortization Schedule (All 13 Excel Columns)</h3>
                            <button onclick="exportScheduleToExcel()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                                üì• Export to Excel
                            </button>
                        </div>
                        <div style="max-height: 500px; overflow-y: auto; overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                                <thead style="position: sticky; top: 0; background: var(--color-sage-1); color: var(--color-text-primary);">
                                    <tr>
                                        <th style="padding: 8px; border: 1px solid #ddd; min-width: 80px;">Date</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; min-width: 80px;">Rent</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; min-width: 70px;">PV Factor</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; min-width: 80px;">Interest</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; min-width: 90px;">Liability</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; min-width: 80px;">PV of Rent</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; min-width: 90px;">ROU Asset</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; min-width: 85px;">Depreciation</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; min-width: 85px;">Change ROU</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; min-width: 85px;">Sec Dep PV</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; min-width: 80px;">ARO Gross</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; min-width: 80px;">ARO Interest</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; min-width: 85px;">ARO Provision</th>
                                    </tr>
                                </thead>
                                <tbody id="schedule_body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Journal Entries - Excel-style Structure -->
                    <div style="margin-top: 30px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: var(--color-text-primary); margin: 0;">üìî Journal Entries (Excel JournalD Structure)</h3>
                            <button onclick="exportJournalsToExcel()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                                üì• Export to Excel
                            </button>
                        </div>
                        <div style="max-height: 500px; overflow-y: auto; overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                                <thead style="position: sticky; top: 0; background: var(--color-sage-1); color: var(--color-text-primary);">
                                    <tr>
                                        <th style="padding: 8px; border: 1px solid #ddd;">BS/PL</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">Account Name</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">Result Period</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">Previous Period</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">Incremental Adjustment</th>
                                    </tr>
                                </thead>
                                <tbody id="journal_body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Disclosures -->
                    <div style="margin-top: 30px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: var(--color-text-primary); margin-bottom: 15px; text-align: center;">üìã Lease Disclosures</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="background: var(--color-bg-light); border: 1px solid var(--color-border-sage); padding: 15px; border-radius: 8px;">
                                <h4 style="color: var(--color-text-primary); margin-bottom: 10px;">Balance Sheet Impact</h4>
                                <div style="font-size: 0.9rem;">
                                    <p><strong>Right-of-Use Asset (Opening):</strong> $${results.rou_asset}</p>
                                    <p><strong>Lease Liability (Opening):</strong> $${results.lease_liability}</p>
                                    <p><strong>Remaining Useful Life:</strong> ${tenure} months</p>
                                    <p><strong>Accumulated Depreciation:</strong> $${(parseFloat(results.depreciation_expense) * tenure).toFixed(2)}</p>
                                </div>
                            </div>
                            <div style="background: var(--color-bg-light); border: 1px solid var(--color-border-sage); padding: 15px; border-radius: 8px;">
                                <h4 style="color: var(--color-text-primary); margin-bottom: 10px;">Income Statement Impact</h4>
                                <div style="font-size: 0.9rem;">
                                    <p><strong>Annual Interest Expense:</strong> $${totalInterest.toFixed(2)}</p>
                                    <p><strong>Annual Depreciation Expense:</strong> $${(parseFloat(results.depreciation_expense) * 12).toFixed(2)}</p>
                                    <p><strong>Total Lease Cost:</strong> $${results.total_cost}</p>
                                    <p><strong>Lease Term:</strong> ${tenure} months</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Generate amortization schedule
            generateAmortizationSchedule(results, rental, tenure, frequency, borrowingRate, totalInterest, totalRentalPayments, leaseIncentive);
            
            // Generate journal entries
            generateCompleteJournalEntries(results, rental, totalInterest, tenure);
            
            document.getElementById('results').classList.add('show');
        }
        
        function generateCompleteJournalEntries_OLD_DO_NOT_USE(results, rental, totalInterest, tenure) {
            const tbody = document.getElementById('journal_body');
            tbody.innerHTML = '';
            
            const monthlyInterest = totalInterest / tenure;
            const monthlyPayment = rental;
            const monthlyPrincipal = monthlyPayment - monthlyInterest;
            const depreciation = parseFloat(results.depreciation_expense) || 0;
            
            // Journal entries matching Excel structure
            const journalEntries = [
                { bs_pl: 'BS', account: 'Lease Liability Non-current', amount: -(results.lease_liability || 0) * 0.7 },
                { bs_pl: 'BS', account: 'Lease Liability Current', amount: -(results.lease_liability || 0) * 0.3 },
                { bs_pl: 'PL', account: 'Interest Cost', amount: monthlyInterest * 12 },
                { bs_pl: 'BS', account: 'RoU Asset (net)', amount: results.rou_asset || 0 },
                { bs_pl: 'PL', account: 'Depreciation', amount: depreciation * 12 },
                { bs_pl: 'PL', account: '(Gain)/Loss in P&L', amount: 0 },
                { bs_pl: 'PL', account: 'ARO Interest', amount: (results.aro_amount || 0) * (results.borrowing_rate || 0) / 100 },
                { bs_pl: 'BS', account: 'ARO Provision Closing', amount: results.aro_amount || 0 },
                { bs_pl: 'PL', account: 'Interest on Security Dep', amount: 0 },
                { bs_pl: 'BS', account: 'Security Deposit Non-current', amount: -(results.security_deposit || 0) * 0.7 },
                { bs_pl: 'BS', account: 'Security Deposit Current', amount: -(results.security_deposit || 0) * 0.3 },
                { bs_pl: 'PL', account: 'Rent Paid', amount: -monthlyPayment * 12 },
                { bs_pl: 'PL', account: 'Initial direct expenditure', amount: 0 },
                { bs_pl: 'BS', account: 'Prepaid', amount: 0 },
                { bs_pl: 'BS', account: 'Retained Earnings', amount: 0 }
            ];
            
            journalEntries.forEach(entry => {
                const row = document.createElement('tr');
                const amount = entry.amount || 0;
                const incremental = amount || 0; // Simplified - would compare with previous
                
                row.innerHTML = `
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">${entry.bs_pl}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${entry.account}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${Math.abs(amount).toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$0.00</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${Math.abs(incremental).toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function generateAmortizationSchedule_OLD_DO_NOT_USE(results, rental, tenure, frequency, borrowingRate, totalInterest, totalRentalPayments, leaseIncentive) {
            const tbody = document.getElementById('schedule_body');
            tbody.innerHTML = '';
            
            const monthlyRate = borrowingRate / 100 / 12;
            let leaseLiability = totalRentalPayments - totalInterest + (results.initial_direct_costs - leaseIncentive);
            let rouAsset = leaseLiability;
            const monthlyPayment = rental;
            const monthlyInterest = totalInterest / tenure;
            const monthlyPrincipal = monthlyPayment - monthlyInterest;
            const monthlyDepreciation = rouAsset / tenure;
            let aroGross = parseFloat(results.aro_amount) || 0;
            let aroLiability = aroGross;
            const monthlyAROInterest = aroGross * (borrowingRate / 100 / 12);
            
            const currentDate = new Date();
            
            for (let i = 0; i < Math.min(12, tenure); i++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() + i, 1);
                const formattedDate = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                
                // Calculate PV factor (Column E)
                const daysFromStart = i * 30;
                const pvFactor = 1 / ((1 + monthlyRate) ** (daysFromStart / 30));
                
                // Update balances
                leaseLiability -= monthlyPrincipal;
                rouAsset -= monthlyDepreciation;
                
                // Calculate change in ROU (Column K) - simplified
                const prevAroLiability = i == 0 ? 0 : aroLiability - monthlyAROInterest;
                const changeInROU = aroLiability - prevAroLiability;
                
                // Update ARO
                aroLiability += monthlyAROInterest;
                
                // Security deposit PV (Column L) - simplified decreasing
                const securityDepPV = (results.security_deposit || 0) * (1 - (i + 1) / tenure);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 8px; border: 1px solid #ddd;">${formattedDate}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">$${monthlyPayment.toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${pvFactor.toFixed(4)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">$${monthlyInterest.toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">$${Math.abs(leaseLiability).toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">$${(monthlyPayment * pvFactor).toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">$${rouAsset.toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">$${monthlyDepreciation.toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">$${changeInROU.toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">$${securityDepPV.toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">$${aroGross.toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">$${monthlyAROInterest.toFixed(2)}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">$${aroLiability.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            }
            
            // Add totals row
            const totalsRow = document.createElement('tr');
            totalsRow.style.background = '#f8f9fa';
            totalsRow.style.fontWeight = 'bold';
            totalsRow.innerHTML = `
                <td style="padding: 8px; border: 1px solid #ddd;">Total</td>
                <td style="padding: 8px; border: 1px solid #ddd;">$${(monthlyPayment * Math.min(12, tenure)).toFixed(2)}</td>
                <td style="padding: 8px; border: 1px solid #ddd;">-</td>
                <td style="padding: 8px; border: 1px solid #ddd;">$${(monthlyInterest * Math.min(12, tenure)).toFixed(2)}</td>
                <td style="padding: 8px; border: 1px solid #ddd;">-</td>
                <td style="padding: 8px; border: 1px solid #ddd;">-</td>
                <td style="padding: 8px; border: 1px solid #ddd;">-</td>
                <td style="padding: 8px; border: 1px solid #ddd;">$${(monthlyDepreciation * Math.min(12, tenure)).toFixed(2)}</td>
                <td style="padding: 8px; border: 1px solid #ddd;">-</td>
                <td style="padding: 8px; border: 1px solid #ddd;">-</td>
                <td style="padding: 8px; border: 1px solid #ddd;">-</td>
                <td style="padding: 8px; border: 1px solid #ddd;">$${(monthlyAROInterest * Math.min(12, tenure)).toFixed(2)}</td>
                <td style="padding: 8px; border: 1px solid #ddd;">-</td>
            `;
            tbody.appendChild(totalsRow);
        }
        
        function exportScheduleToExcel() {
            const table = document.querySelector('#schedule_body').parentElement.parentElement;
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.table_to_sheet(table);
            
            // Add formatting
            const range = XLSX.utils.decode_range(ws['!ref']);
            
            // Set column widths
            ws['!cols'] = [
                { wch: 12 }, // Date
                { wch: 12 }, // Rent
                { wch: 10 }, // PV Factor
                { wch: 12 }, // Interest
                { wch: 14 }, // Liability
                { wch: 12 }, // PV of Rent
                { wch: 12 }, // ROU Asset
                { wch: 12 }, // Depreciation
                { wch: 12 }, // Change ROU
                { wch: 12 }, // Sec Dep PV
                { wch: 12 }, // ARO Gross
                { wch: 12 }, // ARO Interest
                { wch: 12 }  // ARO Provision
            ];
            
            // Add currency formatting for numeric columns (2-13, skipping Date which is column 0)
            for (let R = 1; R <= range.e.r; R++) {
                for (let C = 1; C <= 12; C++) {
                    const cell_ref = XLSX.utils.encode_cell({ r: R, c: C });
                    if (ws[cell_ref] && ws[cell_ref].t === 'n') {
                        ws[cell_ref].z = '$#,##0.00';
                    }
                }
            }
            
            XLSX.utils.book_append_sheet(wb, ws, "Amortization Schedule");
            XLSX.writeFile(wb, "Lease_Amortization_Schedule.xlsx");
        }
        
        function exportJournalsToExcel() {
            const tables = document.querySelectorAll('table');
            const wb = XLSX.utils.book_new();
            
            // Add schedule with formatting
            if (tables[1]) {
                const ws = XLSX.utils.table_to_sheet(tables[1]);
                const range = XLSX.utils.decode_range(ws['!ref']);
                
                ws['!cols'] = [
                    { wch: 10 }, { wch: 30 }, { wch: 18 }, { wch: 18 }, { wch: 18 }
                ];
                
                for (let R = 1; R <= range.e.r; R++) {
                    for (let C = 2; C <= 4; C++) {
                        const cell_ref = XLSX.utils.encode_cell({ r: R, c: C });
                        if (ws[cell_ref] && ws[cell_ref].t === 'n') {
                            ws[cell_ref].z = '$#,##0.00';
                        }
                    }
                }
                
                XLSX.utils.book_append_sheet(wb, ws, "Amortization Schedule");
            }
            
            // Add journal entries
            if (tables[2]) {
                const ws = XLSX.utils.table_to_sheet(tables[2]);
                const range = XLSX.utils.decode_range(ws['!ref']);
                
                ws['!cols'] = [
                    { wch: 8 }, { wch: 40 }, { wch: 18 }, { wch: 18 }, { wch: 18 }
                ];
                
                // Format currency columns
                for (let R = 1; R <= range.e.r; R++) {
                    for (let C = 2; C <= 4; C++) {
                        const cell_ref = XLSX.utils.encode_cell({ r: R, c: C });
                        if (ws[cell_ref]) {
                            // Try to parse as number
                            const val = parseFloat(ws[cell_ref].v);
                            if (!isNaN(val)) {
                                ws[cell_ref].z = '$#,##0.00';
                                ws[cell_ref].t = 'n';
                                ws[cell_ref].v = val;
                            }
                        }
                    }
                }
                
                XLSX.utils.book_append_sheet(wb, ws, "Journal Entries");
            }
            
            XLSX.writeFile(wb, "Lease_Complete_Report.xlsx");
        }
        
        function displayPythonResults(result) {
            // Display results from Python backend
            const resultsDiv = document.getElementById('results');
            if (!resultsDiv) {
                console.error('Results div not found');
                alert('Error: Results container not found');
                return;
            }
            
            console.log('Displaying results:', result);
            
            // Build complete results HTML with styled tables
            let scheduleHTML = `
                <table style="width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.9rem;">
                    <thead>
                        <tr style="background: var(--color-sage-1); color: var(--color-text-primary);">
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Date</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Rent</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">PV Factor</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Interest</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Liability</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">PV Rent</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">ROU Asset</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Depreciation</th>
                        </tr>
                    </thead>
                    <tbody id="schedule_body"></tbody>
                </table>
            `;
            
            let journalHTML = `
                <table style="width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.9rem;">
                    <thead>
                        <tr style="background: var(--color-sage-1); color: var(--color-text-primary);">
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">BS/PL</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">Account</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Result Period</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Previous</th>
                            <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Incremental</th>
                        </tr>
                    </thead>
                    <tbody id="journal_body"></tbody>
                </table>
            `;
            
            resultsDiv.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin: 20px 0;">
                    <h2 style="color: var(--color-text-primary); margin-bottom: 25px; text-align: center;">üìä Lease Calculation Results</h2>
                    
                    <div style="background: var(--color-bg-light); border: 1px solid var(--color-border-sage); padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                        <h3 style="margin: 0 0 15px 0;">Summary</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; font-size: 1rem;">
                            <div style="background: white; border: 1px solid var(--color-border-sage); padding: 12px; border-radius: 5px;">
                                <strong>Total Payments:</strong> ${result.summary.total_payments}
                            </div>
                            <div style="background: white; border: 1px solid var(--color-border-sage); padding: 12px; border-radius: 5px;">
                                <strong>Opening Liability:</strong> $${result.summary.opening_liability.toFixed(2)}
                            </div>
                            <div style="background: white; border: 1px solid var(--color-border-sage); padding: 12px; border-radius: 5px;">
                                <strong>Total Interest:</strong> $${result.summary.total_interest.toFixed(2)}
                            </div>
                            <div style="background: white; border: 1px solid var(--color-border-sage); padding: 12px; border-radius: 5px;">
                                <strong>Total Depreciation:</strong> $${result.summary.total_depreciation.toFixed(2)}
                            </div>
                            <div style="background: white; border: 1px solid var(--color-border-sage); padding: 12px; border-radius: 5px;">
                                <strong>Total Rent Paid:</strong> $${result.summary.total_rent_paid.toFixed(2)}
                            </div>
                            <div style="background: white; border: 1px solid var(--color-border-sage); padding: 12px; border-radius: 5px;">
                                <strong>Closing Liability:</strong> $${result.summary.closing_liability.toFixed(2)}
                            </div>
                        </div>
                    </div>
                    
                    <h3 style="color: #333; margin: 30px 0 15px 0;">üìÖ Amortization Schedule</h3>
                    <div style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
                        ${scheduleHTML}
                    </div>
                    
                    <h3 style="color: #333; margin: 30px 0 15px 0;">üìù Journal Entries</h3>
                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
                        ${journalHTML}
                    </div>
                    
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-top: 25px; text-align: center;">
                        <strong>‚úÖ Python backend calculations complete!</strong>
                    </div>
                    
                    <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center;">
                        <button onclick="exportPythonResultsToExcel()" style="background: #28a745; color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                            üì• Download Results to Excel
                        </button>
                        <button onclick="window.showEmailModal && window.showEmailModal()" style="background: #007bff; color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                            üìß Email Report
                        </button>
                    </div>
                </div>
            `;
            
            // Now populate the tables
            generatePythonSchedule(result.schedule);
            generatePythonJournals(result.journal_entries);
            
            // Store result globally for export
            window.lastLeaseResult = result;
        }
        
        function exportPythonResultsToExcel() {
            if (!window.lastLeaseResult) {
                alert('No results to export');
                return;
            }
            
            const result = window.lastLeaseResult;
            const wb = XLSX.utils.book_new();
            
            // 1. ENHANCED Summary Sheet with metadata
            const today = new Date();
            const summaryData = [
                ['LEASE CALCULATION SUMMARY REPORT'],
                [],
                ['Report Information'],
                ['Generated Date', today.toLocaleDateString() + ' ' + today.toLocaleTimeString()],
                [],
                ['Financial Summary'],
                ['Opening Lease Liability', result.summary.opening_liability || 0],
                ['Closing Lease Liability', result.summary.closing_liability || 0],
                ['Total Interest Expense', result.summary.total_interest || 0],
                ['Total Depreciation Expense', result.summary.total_depreciation || 0],
                ['Total Rent Paid', result.summary.total_rent_paid || 0],
                ['Total Payments', result.summary.total_payments || 0]
            ];
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            summaryWs['!cols'] = [{ wch: 30 }, { wch: 22 }];
            // Format currency values (rows 7-12)
            for (let i = 7; i <= 12; i++) {
                const cell = summaryWs['B' + (i + 1)];
                if (cell && cell.t === 'n') cell.z = '$#,##0.00';
            }
            XLSX.utils.book_append_sheet(wb, summaryWs, "Summary");
            
            // 2. ENHANCED Amortization Schedule with proper date formatting
            const scheduleData = [['Date', 'Rent', 'PV Factor', 'Interest', 'Liability', 'PV Rent', 'ROU Asset', 'Depreciation']];
            result.schedule.forEach(row => {
                scheduleData.push([
                    row.date ? new Date(row.date) : '',  // Convert to Date object
                    row.rental_amount,
                    row.pv_factor,
                    row.interest,
                    row.lease_liability,
                    row.pv_of_rent,
                    row.rou_asset,
                    row.depreciation
                ]);
            });
            const scheduleWs = XLSX.utils.aoa_to_sheet(scheduleData);
            scheduleWs['!cols'] = [{ wch: 12 }, { wch: 15 }, { wch: 12 }, { wch: 15 }, { wch: 18 }, { wch: 15 }, { wch: 15 }, { wch: 15 }];
            
            // Apply comprehensive formatting
            const range = XLSX.utils.decode_range(scheduleWs['!ref']);
            for (let R = 1; R <= range.e.r; R++) {
                // Format dates
                const dateCell = scheduleWs[XLSX.utils.encode_cell({ r: R, c: 0 })];
                if (dateCell && dateCell.t === 'd') dateCell.z = 'mm/dd/yyyy';
                
                // Format currency columns (B, D, E, F, G, H)
                [1, 3, 4, 5, 6, 7].forEach(colIdx => {
                    const cell = scheduleWs[XLSX.utils.encode_cell({ r: R, c: colIdx })];
                    if (cell && cell.t === 'n') cell.z = '$#,##0.00';
                });
            }
            XLSX.utils.book_append_sheet(wb, scheduleWs, "Amortization Schedule");
            
            // 3. ENHANCED Journal Entries with all columns
            const journalData = [['Account Code', 'Account Name', 'BS/PL', 'Result Period', 'Previous Period', 'Incremental Adjustment', 'US-GAAP Entry', 'IFRS Adjustment']];
            result.journal_entries.forEach(entry => {
                journalData.push([
                    entry.account_code || '',
                    entry.account_name || '',
                    entry.bs_pl || '',
                    entry.result_period || 0,
                    entry.previous_period || 0,
                    entry.incremental_adjustment || 0,
                    entry.usgaap_entry || 0,
                    entry.ifrs_adjustment || 0
                ]);
            });
            const journalWs = XLSX.utils.aoa_to_sheet(journalData);
            journalWs['!cols'] = [{ wch: 12 }, { wch: 35 }, { wch: 8 }, { wch: 18 }, { wch: 18 }, { wch: 22 }, { wch: 18 }, { wch: 18 }];
            
            // Format currency columns
            const journalRange = XLSX.utils.decode_range(journalWs['!ref']);
            for (let R = 1; R <= journalRange.e.r; R++) {
                [3, 4, 5, 6, 7].forEach(colIdx => {  // Columns D-H
                    const cell = journalWs[XLSX.utils.encode_cell({ r: R, c: colIdx })];
                    if (cell && cell.t === 'n') cell.z = '$#,##0.00';
                });
            }
            XLSX.utils.book_append_sheet(wb, journalWs, "Journal Entries");
            
            // Download with timestamp
            const timestamp = today.toISOString().split('T')[0].replace(/-/g, '');
            const filename = `Lease_Report_${timestamp}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            alert('‚úÖ Enhanced Excel report downloaded!\n\nFeatures:\n‚Ä¢ Professional summary with metadata\n‚Ä¢ Formatted dates and currency\n‚Ä¢ Complete journal entries\n‚Ä¢ Timestamped filename');
        }
        
        function generatePythonSchedule(schedule) {
            const tbody = document.getElementById('schedule_body');
            if (!tbody) {
                console.error('schedule_body not found - table not created yet');
                return;
            }
            tbody.innerHTML = '';
            
            schedule.forEach((row, idx) => {
                const tr = document.createElement('tr');
                const bgColor = idx % 2 === 0 ? '#f8f9fa' : '#ffffff';
                tr.style.backgroundColor = bgColor;
                tr.innerHTML = `
                    <td style="padding: 10px; border: 1px solid #ddd;">${row.date}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">$${row.rental_amount.toFixed(2)}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${row.pv_factor.toFixed(4)}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">$${row.interest.toFixed(2)}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">$${row.lease_liability.toFixed(2)}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">$${row.pv_of_rent.toFixed(2)}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">$${row.rou_asset.toFixed(2)}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">$${row.depreciation.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function generatePythonJournals(journals) {
            const tbody = document.getElementById('journal_body');
            if (!tbody) {
                console.error('journal_body not found - table not created yet');
                return;
            }
            tbody.innerHTML = '';
            
            journals.forEach((entry, idx) => {
                const tr = document.createElement('tr');
                const bgColor = idx % 2 === 0 ? '#f8f9fa' : '#ffffff';
                tr.style.backgroundColor = bgColor;
                tr.innerHTML = `
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: 500;">${entry.account_code || '-'}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: left;">${entry.account_name || ''}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: 500;">${entry.bs_pl || ''}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">$${(entry.result_period || 0).toFixed(2)}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">$${(entry.previous_period || 0).toFixed(2)}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: 500;">$${(entry.incremental_adjustment || 0).toFixed(2)}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">$${(entry.usgaap_entry || 0).toFixed(2)}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">$${(entry.ifrs_adjustment || 0).toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function generatePythonJournals_OLD(journals) {
            const tbody = document.getElementById('journal_body');
            if (!tbody) {
                console.error('journal_body not found - table not created yet');
                return;
            }
            tbody.innerHTML = '';
            
            journals.forEach((entry, idx) => {
                const tr = document.createElement('tr');
                const bgColor = idx % 2 === 0 ? '#f8f9fa' : '#ffffff';
                tr.style.backgroundColor = bgColor;
                tr.innerHTML = `
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${entry.bs_pl}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: left;">${entry.account_name}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">$${entry.result_period.toFixed(2)}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">$${entry.previous_period.toFixed(2)}</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">$${entry.incremental_adjustment.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Document Management Functions
        let currentLeaseId = null;
        let isAdminOrReviewer = false;

        async function loadDocuments() {
            if (!currentLeaseId) {
                document.getElementById('documentsList').innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #6c757d;">
                        <p style="font-size: 1.1rem;">üìÑ No documents uploaded yet</p>
                        <p style="margin-top: 10px; font-size: 0.9rem;">Upload your first document using the form above.</p>
                        <p style="margin-top: 10px; font-size: 0.85rem; color: var(--color-text-secondary);">üí° The lease will be saved automatically when you upload a document.</p>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`http://localhost:5001/api/documents/${currentLeaseId}`, {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    displayDocuments(data.documents || []);
                } else {
                    displayDocuments([]);
                }
            } catch (error) {
                console.error('Error loading documents:', error);
                document.getElementById('documentsList').innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #dc3545;">
                        <p>Error loading documents: ${error.message}</p>
                    </div>
                `;
            }
        }

        function displayDocuments(documents) {
            const container = document.getElementById('documentsList');
            
            if (documents.length === 0) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #6c757d;">
                        <p style="font-size: 1.1rem;">üìÑ No documents uploaded yet</p>
                        <p style="margin-top: 10px; font-size: 0.9rem;">Upload your first document using the form above.</p>
                    </div>
                `;
                return;
            }

            let html = '<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;"><th style="padding: 12px; text-align: left; font-weight: 600;">Filename</th><th style="padding: 12px; text-align: left; font-weight: 600;">Type</th><th style="padding: 12px; text-align: left; font-weight: 600;">Size</th><th style="padding: 12px; text-align: left; font-weight: 600;">Uploaded</th><th style="padding: 12px; text-align: center; font-weight: 600;">Actions</th></tr></thead><tbody>';
            
            documents.forEach(doc => {
                html += `
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 12px;">${escapeHtml(doc.original_filename)}</td>
                        <td style="padding: 12px;"><span style="padding: 4px 8px; background: #e9ecef; border-radius: 4px; font-size: 0.85rem;">${doc.document_type}</span></td>
                        <td style="padding: 12px;">${doc.file_size_formatted}</td>
                        <td style="padding: 12px;">${new Date(doc.uploaded_at).toLocaleDateString()}</td>
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="downloadDocument(${doc.doc_id})" style="padding: 6px 12px; background: var(--color-brand-green); color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">‚¨áÔ∏è Download</button>
                            <button onclick="deleteDocument(${doc.doc_id})" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function uploadDocument() {
            const fileInput = document.getElementById('documentFileInput');
            const docTypeSelect = document.getElementById('documentTypeSelect');
            const statusDiv = document.getElementById('uploadStatus');

            if (!fileInput.files || fileInput.files.length === 0) {
                showNotification('error', 'No File Selected', 'Please select a file first.');
                return;
            }

            // Show progress bar
            NProgress.start();

            // If no lease_id yet, save the lease first
            if (!currentLeaseId) {
                statusDiv.innerHTML = '<span style="color: #007bff;">‚è≥ Saving lease first...</span>';
                
                try {
                    const savedLeaseId = await saveLeaseSilently();
                    
                    if (!savedLeaseId) {
                        NProgress.done();
                        statusDiv.innerHTML = '';
                        showNotification('error', 'Save Failed', 'Please fill in all required fields (marked with *) and try again.');
                        return;
                    }
                    
                    currentLeaseId = savedLeaseId;
                    statusDiv.innerHTML = '<span style="color: #007bff;">‚úÖ Lease saved, uploading document...</span>';
                    showNotification('success', 'Lease Saved', 'Now uploading document...', 2000);
                } catch (error) {
                    NProgress.done();
                    statusDiv.innerHTML = '';
                    showNotification('error', 'Save Error', error.message);
                    return;
                }
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('lease_id', currentLeaseId);
            formData.append('document_type', docTypeSelect.value);

            statusDiv.innerHTML = '<span style="color: #007bff;">‚è≥ Uploading...</span>';

            try {
                const response = await fetch('http://localhost:5001/api/documents/upload', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.success) {
                    NProgress.done();
                    statusDiv.innerHTML = '';
                    fileInput.value = '';
                    showNotification('success', 'Upload Successful', `Document "${data.filename}" uploaded successfully!`, 4000);
                    await loadDocuments();
                } else {
                    NProgress.done();
                    statusDiv.innerHTML = '';
                    showNotification('error', 'Upload Failed', data.error || 'Failed to upload document.');
                }
            } catch (error) {
                NProgress.done();
                console.error('Upload error:', error);
                statusDiv.innerHTML = '';
                showNotification('error', 'Upload Error', error.message);
            }
        }
        
        // Helper function to save lease without redirecting
        async function saveLeaseSilently() {
            try {
                // Get and validate form data
                const formData = new FormData(document.getElementById('leaseForm'));
                const data = Object.fromEntries(formData);
                
                // Validate required fields (same as saveLease)
                const requiredFields = {
                    'asset_name': 'Asset Name',
                    'asset_class': 'Asset Class',
                    'lease_start': 'Lease Start Date',
                    'first_payment': 'First Payment Date',
                    'end_date': 'Lease End Date',
                    'frequency': 'Rental Frequency',
                    'day_of_month': 'Day of Month',
                    'accrual_day': 'Rent Accrual Day',
                    'borrowing_rate': 'Borrowing Rate'
                };
                
                const missingFields = [];
                for (const [field, label] of Object.entries(requiredFields)) {
                    const value = data[field] || document.getElementById(field)?.value;
                    if (!value || value.trim() === '' || value === 'Select...') {
                        missingFields.push(label);
                    }
                }
                
                // Also check if rental amount is needed (when auto_rentals is enabled)
                const autoRentals = document.getElementById('auto_rentals')?.checked;
                if (autoRentals) {
                    const rentalAmount = data['rental_amount'] || document.getElementById('rental_amount')?.value;
                    if (!rentalAmount || rentalAmount.trim() === '') {
                        missingFields.push('Rental Amount');
                    }
                }
                
                if (missingFields.length > 0) {
                    return null; // Validation failed
                }
                
                // Map fields (same as saveLease)
                const fieldMappings = {
                    'Escalation_Start': 'escalation_start_date',
                    'escalation_start_date': 'escalation_start_date',
                    'Esc_Freq_months': 'esc_freq_months',
                    'esc_freq_months': 'esc_freq_months',
                    'Asset_Name': 'lease_name',  // Asset name maps to lease_name in DB
                    'Rental_1': 'rental_1',
                    'Rental_2': 'rental_2',
                    'lease_start': 'lease_start_date',
                    'first_payment': 'first_payment_date',
                    'end_date': 'end_date',
                    'day_of_month': 'day_of_month',
                    'frequency': 'frequency_months',
                    'Escalation_percent': 'escalation_percent',
                    'Borrowing_rate': 'borrowing_rate',
                    'initial_direct_costs': 'initial_direct_expenditure',
                    'initial_direct_expenditure': 'initial_direct_expenditure',
                    'Security_deposit': 'security_deposit',
                    'ARO': 'aro',
                    'aro_initial': 'aro',
                    'Lease_incentive': 'lease_incentive',
                    'Finance_lease': 'finance_lease_usgaap',
                    'Short_term_ifrs': 'shortterm_lease_ifrs_indas',
                    'Is_sublease': 'sublease'
                };
                
                const mappedData = {};
                for (const [key, value] of Object.entries(data)) {
                    let backendKey = fieldMappings[key] || key.replace(/-/g, '_').toLowerCase();
                    if (fieldMappings[key] && mappedData[backendKey] === undefined) {
                        mappedData[backendKey] = value || '';
                    } else if (!fieldMappings[key] && !mappedData[backendKey]) {
                        mappedData[backendKey] = value || '';
                    }
                }
                
                // Ensure escalation fields
                if (mappedData['escalation_start_date'] === undefined) {
                    mappedData['escalation_start_date'] = data['Escalation_Start'] || data['escalation_start_date'] || '';
                }
                if (mappedData['esc_freq_months'] === undefined) {
                    mappedData['esc_freq_months'] = data['Esc_Freq_months'] || data['esc_freq_months'] || '';
                }
                
                // Save to backend
                const urlParams = new URLSearchParams(window.location.search);
                const leaseId = urlParams.get('id') || urlParams.get('lease_id');
                const isEdit = !!leaseId;
                
                const url = isEdit 
                    ? `http://localhost:5001/api/leases/${leaseId}`
                    : 'http://localhost:5001/api/leases';
                
                const method = isEdit ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(mappedData),
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.lease_id) {
                        return result.lease_id;
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Silent save error:', error);
                return null;
            }
        }

        async function downloadDocument(docId) {
            window.open(`http://localhost:5001/api/document/download/${docId}`, '_blank');
        }

        async function deleteDocument(docId) {
            if (!confirm('Are you sure you want to delete this document?')) {
                return;
            }

            NProgress.start();

            try {
                const response = await fetch(`http://localhost:5001/api/document/delete/${docId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.success) {
                    NProgress.done();
                    showNotification('success', 'Document Deleted', 'Document has been deleted successfully.', 3000);
                    await loadDocuments();
                } else {
                    NProgress.done();
                    showNotification('error', 'Delete Failed', data.error || 'Failed to delete document.');
                }
            } catch (error) {
                NProgress.done();
                console.error('Delete error:', error);
                showNotification('error', 'Delete Error', error.message);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Set currentLeaseId when lease is loaded for editing
        const originalLoadLeaseForEdit = loadLeaseForEdit;
        loadLeaseForEdit = async function(leaseId) {
            await originalLoadLeaseForEdit(leaseId);
            currentLeaseId = leaseId;
            loadDocuments();
        };

        // Email Modal Functions
        window.showEmailModal = function() {
            // Try to get saved email from user info
            let defaultEmail = '';
            
            // Try to get current user's email from database
            fetch('http://localhost:5001/api/user', {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.user && data.user.email) {
                    defaultEmail = data.user.email;
                }
                document.getElementById('recipientEmail').value = defaultEmail;
                document.getElementById('emailModal').style.display = 'block';
            })
            .catch(err => {
                document.getElementById('recipientEmail').value = '';
                document.getElementById('emailModal').style.display = 'block';
            });
        };
        
        window.hideEmailModal = function() {
            document.getElementById('emailModal').style.display = 'none';
        };
        
        // Submit Approval Modal Functions
        window.showSubmitApprovalModal = function() {
            // Allow opening modal even if not saved - it will auto-save on submit
            document.getElementById('submitApprovalModal').style.display = 'block';
        };
        
        window.hideSubmitApprovalModal = function() {
            document.getElementById('submitApprovalModal').style.display = 'none';
        };
        
        window.submitForApproval = async function() {
            const requestType = document.getElementById('approvalRequestType').value;
            const comments = document.getElementById('approvalComments').value;
            
            hideSubmitApprovalModal();
            NProgress.start();
            
            try {
                // If lease is not saved yet, save it first
                if (!currentLeaseId) {
                    const savedLeaseId = await saveLeaseSilently();
                    if (!savedLeaseId) {
                        NProgress.done();
                        showNotification('error', 'Save Failed', 'Please fill in all required fields before submitting for approval');
                        return;
                    }
                    currentLeaseId = savedLeaseId;
                    
                    // Update status indicator (only for regular users)
                    if (!isAdminOrReviewer) {
                        document.getElementById('statusIndicator').style.display = 'block';
                        document.getElementById('submitApprovalBtn').style.display = 'inline-block';
                    }
                }
                
                const response = await fetch('/api/approvals/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        lease_id: currentLeaseId,
                        request_type: requestType,
                        comments: comments
                    })
                });
                
                const result = await response.json();
                NProgress.done();
                
                if (result.success) {
                    showNotification('success', 'Submitted for Approval', 'Lease submitted successfully. Waiting for reviewer approval.');
                    
                    // Update status indicator to pending (only for regular users)
                    if (!isAdminOrReviewer) {
                        const indicator = document.getElementById('statusIndicator');
                        const indicatorIcon = indicator.querySelector('span');
                        const indicatorTitle = indicator.querySelector('strong');
                        const indicatorDesc = indicator.querySelector('div > div');
                        
                        indicator.style.display = 'block';
                        indicator.style.background = '#fff4e6';
                        indicatorIcon.textContent = '‚è≥';
                        indicatorTitle.textContent = 'Pending Approval';
                        indicatorDesc.textContent = 'Waiting for reviewer approval';
                        document.getElementById('submitApprovalBtn').style.display = 'none';
                    }
                } else {
                    showNotification('error', 'Submission Failed', result.error || 'Failed to submit for approval');
                }
            } catch (ex) {
                NProgress.done();
                showNotification('error', 'Submission Failed', ex.message || 'Could not submit for approval');
            }
        };
        
        // Email Report handler
        window.sendReportEmail = async function() {
            const toEmail = document.getElementById('recipientEmail').value.trim();
            if (!toEmail || !toEmail.match(/^\S+@\S+\.\S+$/)) {
                showNotification('error', 'Invalid Email', 'Please enter a valid recipient email');
                return;
            }
            hideEmailModal();
            NProgress.start();
            try {
                // Use existing Excel logic to get blob
                const wb = XLSX.utils.book_new();
                // Amortization Schedule
                const schedTable = document.querySelector('#schedule_body').parentElement.parentElement;
                const ws1 = XLSX.utils.table_to_sheet(schedTable);
                XLSX.utils.book_append_sheet(wb, ws1, 'Amortization Schedule');
                // Journal entries
                const journalTable = document.querySelector('#journal_body').parentElement.parentElement;
                const ws2 = XLSX.utils.table_to_sheet(journalTable);
                XLSX.utils.book_append_sheet(wb, ws2, 'Journal Entries');
                // To Blob
                const wbout = XLSX.write(wb, {bookType: 'xlsx', type: 'array'});
                const fileBlob = new Blob([wbout], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});

                // Compose FormData
                const formData = new FormData();
                formData.append('to_email', toEmail);
                formData.append('attachment', fileBlob, 'Lease_Report.xlsx');

                // Add summary/report JSON data (if available)
                if (window.lastLeaseResult) {
                    formData.append('report_json', JSON.stringify(window.lastLeaseResult));
                }
                // Call API
                const resp = await fetch('/api/email/send-report', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                const result = await resp.json();
                NProgress.done();
                if (result.success) {
                    showNotification('success', 'Report Emailed', result.message || `Report sent to ${toEmail}`);
                } else {
                    showNotification('error', 'Email Failed', result.error || 'Failed to send report by email');
                }
            } catch (ex) {
                NProgress.done();
                showNotification('error', 'Email Failed', ex.message || 'Could not send email.');
            }
        }
    </script>
</body>
</html>

